<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三美女遊香港 - 行程 Web App (零費用導航版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* 定義港式極簡風格顏色及圖片底色延伸 */
        :root {
            --color-blue: #4169E1;  /* 萊茵藍 (Royal Blue) */
            --color-red: #D93025;   /* 港風紅 (Deep Red) */
            --color-bg-ext: #F5F7F8; /* 圖片底色延伸 (極淺灰藍) */
        }
        
        .bg-royal-blue { background-color: var(--color-blue); }
        .text-royal-blue { color: var(--color-blue); }
        .bg-deep-red { background-color: var(--color-red); }
        .text-deep-red { color: var(--color-red); }
        .bg-extension { background-color: var(--color-bg-ext); }

        /* 隱藏滾動條 */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* 日期選單樣式 */
        .date-item .day-of-week { font-size: 1.1rem; }
        .date-item .date-num { font-size: 2rem; line-height: 1; font-weight: 700; }
        
        /* 模態視窗過渡效果 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* 機票卡片虛線效果 */
        .ticket-card {
            background-color: white; 
            background-size: 100% 100%;
            position: relative; /* 確保 after 和 cutout 相對於它定位 */
        }

        .ticket-card::after {
            content: '';
            position: absolute;
            bottom: 40px; /* 調整虛線位置 */
            left: 0;
            right: 0;
            height: 1px;
            background-image: linear-gradient(to right, #ccc 50%, transparent 50%);
            background-size: 15px 1px;
            background-repeat: repeat-x;
        }

        .ticket-cutout-left {
            position: absolute;
            bottom: 35px; /* 與虛線對齊 */
            left: -10px;
            width: 20px;
            height: 20px;
            background-color: white; /* 內部卡片背景色 */
            border-radius: 50%;
            z-index: 10;
        }
        .ticket-cutout-right {
            position: absolute;
            bottom: 35px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-color: white; /* 內部卡片背景色 */
            border-radius: 50%;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-extension min-h-screen">

<div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen">
    
    <header class="relative">
        <div class="h-[250px] overflow-hidden relative bg-extension">
            <img src="Gemini_Generated_Image_y689rxy689rxy689.jpg" 
                 alt="港式復古橫幅圖片" 
                 class="w-full h-full object-cover mx-auto absolute top-[-10px]">
        </div>
        
        <div class="h-8 bg-white z-10"></div> 

        <div class="absolute top-0 left-0 right-0 z-20 flex justify-between items-center p-4">
            
            <button @click="toggleEditMode" 
                    :class="{'bg-deep-red text-white shadow-xl': isEditMode, 'bg-white/90 text-gray-700': !isEditMode}" 
                    class="p-2 rounded-full transition duration-300 shadow-md flex items-center text-sm">
                <i :class="isEditMode ? 'fas fa-pen-nib' : 'fas fa-eye'" class="mr-1"></i>
                {{ isEditMode ? '編輯中' : '瀏覽模式' }}
            </button>

            <button @click="isMenuOpen = !isMenuOpen" 
                    class="p-3 rounded-xl bg-white/90 text-gray-700 shadow-md hover:bg-white transition duration-300">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>
    
    <Transition name="fade">
    <div v-if="isMenuOpen" class="fixed inset-0 z-40">
        <div @click="isMenuOpen = false" class="absolute inset-0 bg-black opacity-40"></div>
        <div class="absolute top-0 right-0 w-64 bg-white h-full shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">功能選單</h3>
            <ul class="space-y-4">
                <li v-for="menu in menus" :key="menu.tab" 
                    @click="setActiveTab(menu.tab)"
                    :class="{'bg-deep-red text-white shadow-md': activeTab === menu.tab, 'text-gray-700 hover:bg-gray-100': activeTab !== menu.tab}"
                    class="p-3 rounded-lg flex items-center cursor-pointer transition duration-200">
                    <i :class="menu.icon" class="w-5 mr-3"></i>
                    <span>{{ menu.name }}</span>
                </li>
                <li @click="resetData"
                    class="p-3 rounded-lg flex items-center cursor-pointer transition duration-200 text-gray-700 hover:bg-gray-100">
                    <i class="fas fa-trash-alt text-red-500 w-5 mr-3"></i>
                    <span>重設所有資料 (危險動作)</span>
                </li>
            </ul>
        </div>
    </div>
    </Transition>


    <main class="-mt-8 pt-8 relative z-0">
        
        <Transition name="fade" mode="out-in">
        <section v-if="activeTab === 'itinerary'" key="itinerary">
            
            <div class="p-4 pt-0">
                <div class="bg-blue-50 p-3 rounded-xl flex items-center shadow-sm border-l-4 border-royal-blue">
                    <i :class="getWeatherIcon(itineraryData.find(d => d.date === activeDate)?.weather || 'Sunny')" 
                       class="text-orange-400 text-3xl mr-3 flex-shrink-0"></i>
                    <div>
                        <div class="font-bold text-gray-800 flex justify-between items-center">
                            <span>香港當地天氣</span>
                            <span class="text-xs font-normal text-red-500">降雨機率: 15%</span>
                        </div>
                        <p class="text-sm text-gray-600">氣溫: {{ weatherInfo.temp }}°C / 體感: {{ weatherInfo.feel }}°C</p>
                        <p class="text-xs text-blue-600">建議穿著: {{ weatherInfo.clothing }}</p>
                    </div>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2 px-4">每日行程表</h2>

            <div class="flex overflow-x-scroll space-x-4 pb-4 px-4 hide-scrollbar">
                <div v-for="(day, dayIndex) in itineraryData" :key="day.date" 
                     @click="activeDate = day.date"
                     :class="{'bg-royal-blue text-white shadow-xl': activeDate === day.date, 'bg-white border border-gray-200 text-gray-700 hover:bg-gray-50': activeDate !== day.date}" 
                     class="flex-shrink-0 date-item w-16 h-16 flex flex-col items-center justify-center rounded-xl p-1 cursor-pointer transition duration-200">
                    <span class="day-of-week text-sm">{{ day.dayOfWeek }}</span>
                    <span class="date-num">{{ day.date.split('/')[2] }}</span>
                </div>
                <button v-if="isEditMode" @click="addDay" 
                        class="flex-shrink-0 w-16 h-16 flex items-center justify-center rounded-xl bg-green-100 text-green-700 border-2 border-dashed border-green-300 transition duration-200 hover:bg-green-200">
                    <i class="fas fa-plus fa-lg"></i>
                </button>
            </div>
            
            <div class="p-4 pt-0">
                <div v-for="(day, dayIndex) in itineraryData" :key="day.date">
                    <div v-if="activeDate === day.date">
                        
                        <button v-if="isEditMode" @click="openAddModal(day.date)" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                            <i class="fas fa-plus mr-1"></i> 新增景點/美食/活動
                        </button>
                        
                        <div class="space-y-4">
                            <div v-for="(item, index) in day.items" :key="item.id" 
                                 :class="{'cursor-pointer hover:shadow-lg transition duration-200': isEditMode, 'opacity-70': item.category === '交通', 'border-red-500 border-opacity-50': isDragging && draggingItemIndex === index && draggingDate === day.date}"
                                 @click="isEditMode && openEditModal(item, day.date)"
                                 
                                 :draggable="isEditMode && item.category !== '航班' && item.category !== '住宿'" 
                                 @dragstart="handleDragStart($event, index, day.date)"
                                 @dragend="handleDragEnd"
                                 @drop="handleDrop($event, index, day.date)"
                                 @dragover.prevent="handleDragOver($event, index, day.date)"
                                 @dragleave="handleDragLeave"

                                 class="bg-white p-4 rounded-xl shadow-lg border-l-4"
                                 :style="{'border-left-color': item.category === '航班' ? '#9CA3AF' : item.category === '住宿' ? '#4169E1' : '#D93025'}">
                                
                                <div v-if="index > 0" class="mb-2 text-xs text-gray-500 flex items-center font-mono">
                                    <i :class="getTransportIcon(item.transport)" class="mr-1"></i>
                                    <span class="ml-1">交通: {{ item.transportDuration }}</span>
                                </div>
                                
                                <template v-if="item.category === '航班'">
                                    <div class="relative bg-gray-100 p-4 rounded-xl ticket-card border border-gray-300 shadow-md">
                                        <div class="flex justify-between items-center mb-3">
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700"><i class="fas fa-plane-departure mr-1"></i> 航班</span>
                                            <span class="text-xl font-mono font-bold text-deep-red">{{ item.flightNumber }}</span>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-2 text-sm text-gray-700">
                                            <div>
                                                <p class="font-bold text-lg">{{ item.startTime }}</p>
                                                <p class="text-xs text-gray-500">{{ item.fromAirport.split(' ')[0] }}</p>
                                            </div>
                                            <div class="text-center">
                                                <i class="fas fa-arrow-right text-royal-blue"></i>
                                                <p class="text-xs text-gray-500">{{ item.duration }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-lg">{{ item.endTime }}</p>
                                                <p class="text-xs text-gray-500">{{ item.toAirport.split(' ')[0] }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="ticket-cutout-left"></div>
                                        <div class="ticket-cutout-right"></div>

                                        <div class="flex justify-between items-center mt-3 pt-3">
                                            <p class="text-xs text-gray-600">{{ item.airline }}</p>
                                            <p class="text-xs text-gray-600">機型: {{ item.notes.split(' ')[0] }}</p>
                                        </div>
                                    </div>
                                </template>
                                
                                <template v-else>
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                                                  :class="getCategoryClasses(item.category)">
                                                {{ item.category }}
                                            </span>
                                            <h3 class="text-lg font-bold mt-1 text-gray-800">{{ item.name }}</h3>
                                        </div>
                                        <button @click.stop="openGoogleMaps(item.location)" title="導航" class="text-royal-blue hover:text-deep-red transition duration-200 flex-shrink-0 p-2">
                                            <i class="fas fa-route fa-lg"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="mt-2 text-sm text-gray-700 space-y-1">
                                        <p><i class="far fa-clock mr-1 text-royal-blue"></i>**{{ item.startTime }}** - **{{ item.endTime }}** <span class="text-xs text-gray-500 ml-1"> (停留 {{ item.duration }})</span></p>
                                        
                                        <p v-if="item.hoursDisplay"><i class="fas fa-info-circle mr-1"></i>營業時間/備註: {{ item.hoursDisplay }}</p>
                                        <p v-if="item.ticket"><i class="fas fa-ticket-alt mr-1"></i>門票: {{ item.ticket }}</p>
                                        <p v-if="item.notes"><i class="fas fa-comment-dots mr-1"></i>筆記: {{ item.notes }}</p>
                                    </div>
                                </template>
                                <button v-if="isEditMode && item.category !== '航班' && item.category !== '住宿'" 
                                        @click.stop="deleteItineraryItem(day.date, item.id)"
                                        class="absolute bottom-1 right-1 text-xs text-red-400 p-1 hover:text-red-600">
                                        <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section v-else-if="activeTab === 'info'" key="info" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">旅行資訊</h2>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-md border-t-4 border-royal-blue">
                <h3 class="font-bold text-lg mb-2 text-royal-blue"><i class="fas fa-coins mr-1"></i>匯率換算 (HKD 兌 TWD)</h3>
                <p class="text-sm text-gray-500 mb-3">模擬即時匯率: HKD 1 ≈ TWD {{ exchangeRate.toFixed(2) }}</p>
                <div class="flex space-x-2 items-center">
                    <input type="number" v-model.number="foreignAmount" placeholder="輸入 HKD" class="w-1/2 p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    <span class="text-lg font-bold text-deep-red">=</span>
                    <div class="w-1/2 p-2 bg-white border rounded-md font-bold text-gray-700">
                        {{ (foreignAmount * exchangeRate).toFixed(2) }} TWD
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-deep-red">
                <h3 class="font-bold text-lg mb-2 text-deep-red"><i class="fas fa-plane mr-2"></i>航班資訊</h3>
                <div v-for="(flight, type) in flightInfo" :key="type" class="mb-4 pb-2 border-b last:border-b-0">
                    <p class="font-semibold text-gray-700">{{ type === 'to' ? '去程' : '回程' }}</p>
                    <div class="text-sm grid grid-cols-2 gap-x-4">
                        <p>航線: <span class="font-mono">{{ flight.from }} - {{ flight.to }}</span></p>
                        <p>航班: <span class="font-mono">{{ flight.number }}</span></p>
                        <p>起飛: **{{ flight.depTime }}**</p>
                        <p>抵達: **{{ flight.arrTime }}**</p>
                        <p class="col-span-2">飛行時間: {{ flight.duration }} / 機型: {{ flight.model }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-royal-blue">
                <h3 class="font-bold text-lg mb-2 text-royal-blue"><i class="fas fa-hotel mr-2"></i>住宿資訊</h3>
                <div v-for="hotel in accommodationInfo" :key="hotel.name" class="mb-4 pb-2 border-b last:border-b-0">
                    <p class="font-bold text-md">{{ hotel.name }}</p>
                    <p class="text-sm text-gray-600">日期: {{ hotel.dates }}</p>
                    <p class="text-sm text-gray-600">地址: {{ hotel.address }}</p>
                    <button @click="openGoogleMaps(hotel.address)" class="text-xs text-deep-red hover:underline block mt-1"><i class="fas fa-route mr-1"></i>導航至飯店</button>
                </div>
                <p class="text-xs text-gray-400 mt-2">（此資訊需手動修改程式碼）</p>
            </div>
            
        </section>
        
        <section v-else-if="activeTab === 'food'" key="food" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">美食清單 (待開發)</h2>
            <div class="bg-yellow-50 p-4 rounded-xl text-yellow-800">
                此頁面未來可整合您所有想吃的餐廳列表和筆記！
            </div>
        </section>

        <section v-else-if="activeTab === 'shopping'" key="shopping" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">購物清單</h2>
            
            <button v-if="isEditMode" @click="openAddItemModal('shopping')" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                <i class="fas fa-plus mr-1"></i> 新增購物項目
            </button>

            <div class="mb-4 flex space-x-2">
                <button @click="selectedShoppingCategory = 'all'" :class="{'bg-deep-red text-white': selectedShoppingCategory === 'all', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== 'all'}" class="px-3 py-1 rounded-full text-sm">全部</button>
                <button @click="selectedShoppingCategory = '伴手禮'" :class="{'bg-deep-red text-white': selectedShoppingCategory === '伴手禮', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== '伴手禮'}" class="px-3 py-1 rounded-full text-sm">伴手禮</button>
                <button @click="selectedShoppingCategory = '紀念品'" :class="{'bg-deep-red text-white': selectedShoppingCategory === '紀念品', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== '紀念品'}" class="px-3 py-1 rounded-full text-sm">紀念品</button>
            </div>

            <div class="space-y-4">
                <div v-for="(item, index) in filteredShoppingList" :key="item.id" 
                     @click="isEditMode && openAddItemModal('shopping', item)"
                     :class="{'cursor-pointer hover:shadow-lg transition duration-200': isEditMode}"
                     class="bg-white p-4 rounded-xl shadow-md flex items-center border-l-4 border-royal-blue">
                    
                    <div class="w-16 h-16 bg-gray-100 rounded-lg mr-4 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-camera text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">{{ item.name }}</p>
                        <p class="text-xs font-semibold text-deep-red">{{ item.category }}</p>
                        <p v-if="item.notes" class="text-sm text-gray-500">備註: {{ item.notes }}</p>
                    </div>
                    <button v-if="isEditMode" @click.stop="deleteShoppingItem(item.id)" 
                            class="text-red-400 p-1 hover:text-red-600 flex-shrink-0">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <section v-else-if="activeTab === 'expense'" key="expense" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">花費記錄</h2>
            
            <div class="bg-royal-blue text-white p-4 rounded-xl mb-4 shadow-lg text-center">
                <p class="text-sm font-semibold">總花費 (TWD)</p>
                <p class="text-4xl font-bold">{{ totalExpenseTWD.toLocaleString(undefined, { maximumFractionDigits: 0 }) }}</p>
            </div>

            <button v-if="isEditMode" @click="openAddItemModal('expense')" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                <i class="fas fa-plus mr-1"></i> 新增開銷
            </button>

            <div class="space-y-3">
                <div v-for="(item, index) in expenses" :key="item.id" 
                     @click="isEditMode && openAddItemModal('expense', item)"
                     :class="{'cursor-pointer hover:shadow-md transition': isEditMode}"
                     class="bg-white p-3 rounded-xl shadow-sm border-l-4"
                     :style="{'border-left-color': item.paymentMethod === '現金' ? '#10B981' : '#3B82F6'}">
                    <div class="flex justify-between items-center">
                        <div class="flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">{{ item.category }}</span>
                            <p class="font-bold text-gray-800 mt-1">{{ item.name }}</p>
                            <p class="text-xs text-gray-500">
                                {{ item.date }} | {{ item.paymentMethod }}
                                <span v-if="item.payer" class="ml-2 font-semibold text-deep-red">({{ item.payer }})</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-deep-red">{{ item.amount.toLocaleString() }} {{ item.currency }}</p>
                            <p class="text-xs text-gray-500">≈ {{ item.amountTWD.toLocaleString(undefined, { maximumFractionDigits: 0 }) }} TWD</p>
                        </div>
                        <button v-if="isEditMode" @click.stop="deleteExpenseItem(item.id)" 
                                class="text-red-400 p-1 hover:text-red-600 flex-shrink-0 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        </Transition>
        
        <div class="h-10"></div>

    </main>

    <Transition name="fade">
    <div v-if="isModalOpen && currentItem" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4">{{ modalTitle }}</h3>
            
            <form @submit.prevent="saveItem" class="space-y-4">
                
                <template v-if="modalType === 'itinerary'">
                    <div class="text-sm text-gray-600">日期: {{ currentItemDate }}</div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">名稱/標題</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-1">分類</label>
                        <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue" :disabled="isEditModalMode && (currentItem.category === '航班' || currentItem.category === '住宿')">
                            <option v-for="cat in categories.filter(c => c !== '航班')" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>

                    <div v-if="currentItem.category !== '交通'">
                        <label class="block text-sm font-semibold mb-1">地點/地址 (用於導航)</label>
                        <input type="text" v-model="currentItem.location" placeholder="例如: 迪士尼樂園" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-royal-blue space-y-3">
                        <h4 class="font-bold text-royal-blue text-sm">排程設定 (HH:MM)</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold mb-1">手動開始時間 (HH:MM)</label>
                                <input type="text" v-model="currentItem.startTime" placeholder="例如: 10:30" 
                                        pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                                        class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <p class="text-xs text-gray-500 mt-1">留空將自動計算</p>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold mb-1">停留時間 (例如: 2h30m)</label>
                                <input type="text" v-model="currentItem.duration" required 
                                        placeholder="例如: 1h30m"
                                        pattern="(\d+h)?(\d+m)?"
                                        class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4" v-if="isEditModalMode || currentItem.id !== 1">
                            <div>
                                <label class="block text-xs font-semibold mb-1">交通方式 (來自前一站)</label>
                                <select v-model="currentItem.transport" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                                    <option value="步行">步行</option>
                                    <option value="大眾運輸">大眾運輸</option>
                                    <option value="開車">計程車/開車</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">交通時間 (例如: 30m, 1h)</label>
                                <input type="text" v-model="currentItem.transportDuration" required 
                                        placeholder="例如: 25m"
                                        pattern="(\d+h)?(\d+m)?"
                                        class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">門票/費用</label>
                            <input type="text" v-model="currentItem.ticket" placeholder="例如: HKD $300 (已購)" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">營業時間資訊/備註 (手動修改)</label>
                            <textarea v-model="currentItem.hoursDisplay" rows="2" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">個人筆記/提醒</label>
                            <textarea v-model="currentItem.notes" rows="2" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue"></textarea>
                        </div>
                    </div>

                    <p class="text-xs text-red-500 mt-2">注意：航班/住宿為固定項目，不可拖曳。交通行程不需停留時間 (Duration)。</p>

                </template>

                <template v-else-if="modalType === 'shopping'">
                    <div>
                        <label class="block text-sm font-semibold mb-1">商品名稱</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">分類</label>
                        <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            <option value="伴手禮">伴手禮</option>
                            <option value="紀念品">紀念品</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">備註/地點</label>
                        <input type="text" v-model="currentItem.notes" placeholder="例如: 尖沙咀店" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                </template>
                
                <template v-else-if="modalType === 'expense'">
                    <div>
                        <label class="block text-sm font-semibold mb-1">名稱/用途</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">類別</label>
                            <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="交通">交通</option><option value="飲食">飲食</option><option value="購物">購物</option>
                                <option value="住宿">住宿</option><option value="門票">門票</option><option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">日期</label>
                            <input type="text" v-model="currentItem.date" placeholder="例如: 2026/3/7" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold mb-1">金額 (當地貨幣)</label>
                            <input type="number" step="0.01" v-model.number="currentItem.amount" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">貨幣</label>
                            <select v-model="currentItem.currency" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="HKD">HKD</option><option value="TWD">TWD</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">付款人</label>
                            <select v-model="currentItem.payer" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="">請選擇</option>
                                <option value="沛晴">沛晴</option>
                                <option value="芳晨">芳晨</option>
                                <option value="玟妤">玟妤</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">付款方式</label>
                            <select v-model="currentItem.paymentMethod" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="現金">現金</option><option value="信用卡">信用卡</option><option value="悠遊卡/八達通">悠遊卡/八達通</option>
                            </select>
                        </div>
                    </div>
                </template>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" @click="closeModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-royal-blue text-white rounded-lg hover:bg-blue-600">
                        儲存 {{ modalType === 'itinerary' ? '行程' : modalType === 'shopping' ? '商品' : '開銷' }}
                    </button>
                </div>
            </form>
            <p v-if="isEditModalMode && modalType !== 'itinerary'" class="text-xs text-red-500 mt-3 text-right">
                點擊儲存以更新，點擊垃圾桶圖示刪除。
            </p>
        </div>
    </div>
    </Transition>

</div>

<script>
// =================================================================
// 初始資料結構 (供重設用)
// =================================================================
const initialData = {
    // 您的初始 Firebase 資料結構
    itineraryData: [
        {
            date: '2026/03/07',
            dayOfWeek: '週六',
            weather: 'Sunny',
            items: [
                { id: 1, category: '航班', name: '台灣桃園國際機場 (TPE) -> 香港國際機場 (HKG)', location: '香港國際機場', startTime: '09:00', endTime: '10:45', duration: '1h45m', transport: '', transportDuration: '', notes: '預定國泰航空 A330-300', flightNumber: 'CX403', fromAirport: 'TPE', toAirport: 'HKG', airline: 'Cathay Pacific' },
                { id: 2, category: '交通', name: '機場快線往九龍站', location: '九龍站', startTime: '10:45', endTime: '11:30', duration: '45m', transport: '大眾運輸', transportDuration: '45m', notes: '購買八達通', hoursDisplay: '' },
                { id: 3, category: '住宿', name: '香港尖沙咀凱悅酒店', location: '香港九龍尖沙咀河內道18號', startTime: '11:30', endTime: '14:00', duration: '2h30m', transport: '步行', transportDuration: '5m', notes: '先寄放行李', hoursDisplay: '' },
                { id: 4, category: '美食', name: '九記牛腩 (中環)', location: '香港中環歌賦街21號', startTime: '14:00', endTime: '15:30', duration: '1h30m', transport: '大眾運輸', transportDuration: '25m', notes: '必吃清湯牛腩！', hoursDisplay: '12:30–22:30' },
                { id: 5, category: '景點', name: '太平山頂', location: '香港中環花園道33號', startTime: '15:30', endTime: '18:30', duration: '3h00m', transport: '計程車/開車', transportDuration: '15m', notes: '排隊搭纜車時間約1小時', hoursDisplay: '07:00–22:00' },
                { id: 6, category: '美食', name: '晚餐: 避風塘興記 (尖沙咀)', location: '香港尖沙咀樂道21-23號', startTime: '18:30', endTime: '20:30', duration: '2h00m', transport: '大眾運輸', transportDuration: '40m', notes: '吃辣蟹！', hoursDisplay: '18:00–02:00' },
                { id: 7, category: '景點', name: '星光大道', location: '香港九龍尖沙咀海旁', startTime: '20:30', endTime: '22:00', duration: '1h30m', transport: '步行', transportDuration: '5m', notes: '看維多利亞港夜景', hoursDisplay: '全天開放' },
            ]
        },
        {
            date: '2026/03/08',
            dayOfWeek: '週日',
            weather: 'Cloudy',
            items: [
                 { id: 8, category: '景點', name: '香港迪士尼樂園', location: '香港大嶼山竹篙灣', startTime: '09:00', endTime: '21:00', duration: '12h00m', transport: '大眾運輸', transportDuration: '1h00m', notes: '提早半小時入園', hoursDisplay: '10:30–20:30', ticket: 'HKD $799 (已購)' },
                 { id: 9, category: '住宿', name: '香港尖沙咀凱悅酒店', location: '香港九龍尖沙咀河內道18號', startTime: '21:00', endTime: '09:00', duration: '12h00m', transport: '大眾運輸', transportDuration: '1h00m', notes: '回飯店休息', hoursDisplay: '' },
            ]
        },
    ],
    weatherInfo: {
        temp: 22,
        feel: 24,
        clothing: '薄外套、舒適長褲'
    },
    flightInfo: {
        to: { from: 'TPE', to: 'HKG', number: 'CX403', depTime: '09:00', arrTime: '10:45', duration: '1h45m', model: 'A330-300' },
        back: { from: 'HKG', to: 'TPE', number: 'CX408', depTime: '18:00', arrTime: '19:45', duration: '1h45m', model: 'A330-300' },
    },
    accommodationInfo: [
        { name: '香港尖沙咀凱悅酒店', dates: '2026/03/07 - 2026/03/09', address: '香港九龍尖沙咀河內道18號' },
    ],
    shoppingList: [
        { id: 1, name: '美心蛋捲', category: '伴手禮', notes: '機場買', image: '' },
        { id: 2, name: '珍妮曲奇', category: '伴手禮', notes: '尖沙咀店', image: '' },
        { id: 3, name: '香港地鐵模型', category: '紀念品', notes: '電車博物館', image: '' },
    ],
    expenses: [
        { id: 1, name: '機票', amount: 8000, currency: 'TWD', category: '交通', date: '2025/12/01', payer: '沛晴', paymentMethod: '信用卡', amountTWD: 8000 },
        { id: 2, name: '住宿兩晚', amount: 4500, currency: 'HKD', category: '住宿', date: '2026/01/05', payer: '芳晨', paymentMethod: '信用卡', amountTWD: 18000 },
        { id: 3, name: '九記牛腩', amount: 250, currency: 'HKD', category: '飲食', date: '2026/03/07', payer: '玟妤', paymentMethod: '現金', amountTWD: 1000 },
    ],
    exchangeRate: 4.0 // 模擬匯率
};

// =================================================================
// Vue 應用程式邏輯
// =================================================================
const app = Vue.createApp({
    data() {
        return {
            // ==================================================
            // ❗❗❗ Firebase 配置 (已填入您的數值) ❗❗❗
            // ==================================================
            firebaseConfig: {
                apiKey: "AIzaSyD-gOroKPdB2Ao0LDKNC1uEeTDcTRaAeao",
                authDomain: "hong-kong-2026.firebaseapp.com",
                databaseURL: "https://hong-kong-2026-default-rtdb.firebaseio.com",
                projectId: "hong-kong-2026",
                // 這裡只保留了必要的參數
            },
            database: null,
            
            // 應用程式狀態
            isEditMode: false,
            isMenuOpen: false,
            activeTab: 'itinerary', // 預設頁面
            activeDate: '2026/03/07', // 預設顯示日期

            // 行程資料
            itineraryData: initialData.itineraryData,
            weatherInfo: initialData.weatherInfo,
            flightInfo: initialData.flightInfo,
            accommodationInfo: initialData.accommodationInfo,
            shoppingList: initialData.shoppingList,
            expenses: initialData.expenses,
            exchangeRate: initialData.exchangeRate,
            foreignAmount: 100, // 匯率輸入框預設值

            // 模態視窗相關
            isModalOpen: false,
            modalType: 'itinerary', // 'itinerary', 'shopping', 'expense'
            currentItem: null,
            currentItemDate: '',
            isEditModalMode: false,
            
            // 行程項目類別
            categories: ['景點', '美食', '住宿', '交通', '購物', '活動', '其他'],
            
            // 購物清單篩選
            selectedShoppingCategory: 'all',

            // 拖曳相關
            draggingDate: null,
            draggingItemIndex: null,
            isDragging: false,
        };
    },
    computed: {
        modalTitle() {
            if (this.modalType === 'itinerary') {
                return this.isEditModalMode ? '編輯行程' : '新增行程';
            } else if (this.modalType === 'shopping') {
                return this.isEditModalMode ? '編輯購物清單' : '新增購物項目';
            } else if (this.modalType === 'expense') {
                return this.isEditModalMode ? '編輯開銷' : '新增開銷';
            }
            return '';
        },
        filteredShoppingList() {
            if (this.selectedShoppingCategory === 'all') {
                return this.shoppingList;
            }
            return this.shoppingList.filter(item => item.category === this.selectedShoppingCategory);
        },
        totalExpenseTWD() {
            return this.expenses.reduce((total, item) => total + item.amountTWD, 0);
        },
    },
    mounted() {
        this.initializeFirebase();
        this.listenForChanges();
    },
    methods: {
        // --- Firebase 相關方法 ---
        initializeFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(this.firebaseConfig);
            }
            // 設置資料庫參考點
            this.database = firebase.database().ref('hongkong_trips_data_v2');
        },
        listenForChanges() {
            // 從 Firebase 載入資料
            this.database.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // 將載入的資料更新到 Vue data
                    this.itineraryData = data.itineraryData || initialData.itineraryData;
                    this.weatherInfo = data.weatherInfo || initialData.weatherInfo;
                    this.flightInfo = data.flightInfo || initialData.flightInfo;
                    this.accommodationInfo = data.accommodationInfo || initialData.accommodationInfo;
                    this.shoppingList = data.shoppingList || initialData.shoppingList;
                    this.expenses = data.expenses || initialData.expenses;
                    this.exchangeRate = data.exchangeRate || initialData.exchangeRate;

                    // 確保 activeDate 在載入的日期列表中
                    if (!this.itineraryData.find(d => d.date === this.activeDate) && this.itineraryData.length > 0) {
                        this.activeDate = this.itineraryData[0].date;
                    }
                    // 重新計算結束時間
                    this.recalculateAllTime();
                } else {
                    // 如果 Firebase 是空的，則上傳初始資料
                    this.updateFirebase();
                }
            });
        },
        updateFirebase() {
            // 將所有資料寫回 Firebase
            this.database.set({
                itineraryData: this.itineraryData,
                weatherInfo: this.weatherInfo,
                flightInfo: this.flightInfo,
                accommodationInfo: this.accommodationInfo,
                shoppingList: this.shoppingList,
                expenses: this.expenses,
                exchangeRate: this.exchangeRate,
            }).catch(error => {
                console.error("Firebase 寫入失敗:", error);
                alert("資料儲存到 Firebase 失敗，請檢查網路連線。");
            });
        },
        resetData() {
            if (confirm('警告：確定要將所有行程和清單重設為預設範本嗎？此操作無法復原！')) {
                this.database.set(initialData).then(() => {
                    alert('資料已重設為初始範本。');
                }).catch(error => {
                    console.error("Firebase 重設失敗:", error);
                    alert("重設失敗，請檢查網路連線。");
                });
            }
        },

        // --- UI/行程管理方法 ---
        toggleEditMode() {
            this.isEditMode = !this.isEditMode;
            if (!this.isEditMode) {
                // 離開編輯模式時強制儲存
                this.updateFirebase();
            }
        },
        setActiveTab(tab) {
            this.activeTab = tab;
            this.isMenuOpen = false;
        },
        getCategoryClasses(category) {
            switch (category) {
                case '景點': return 'bg-yellow-100 text-yellow-700';
                case '美食': return 'bg-red-100 text-red-700';
                case '住宿': return 'bg-blue-100 text-blue-700';
                case '交通': return 'bg-gray-100 text-gray-700';
                default: return 'bg-purple-100 text-purple-700';
            }
        },
        getWeatherIcon(weather) {
            if (weather.includes('Sunny')) return 'fas fa-sun';
            if (weather.includes('Cloudy')) return 'fas fa-cloud';
            if (weather.includes('Rain')) return 'fas fa-cloud-showers-heavy';
            return 'fas fa-temperature-half';
        },
        getTransportIcon(transport) {
            switch (transport) {
                case '步行': return 'fas fa-walking';
                case '大眾運輸': return 'fas fa-bus';
                case '開車': return 'fas fa-car';
                default: return 'fas fa-route';
            }
        },

        // --- 核心導航函式 (零費用純網址跳轉) ---
        openGoogleMaps(location) {
            if (location) {
                // 1. 對地點名稱進行 URL 編碼
                const encodedLocation = encodeURIComponent(location + ', 香港'); // 加上香港確保準確性
                
                // 2. 構造標準的 Google 地圖搜尋/導航 URL
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
                
                // 3. 在新視窗中開啟
                window.open(mapUrl, '_blank');
            } else {
                alert("無法導航：地點資訊為空，請在編輯模式中填寫地點/地址。");
            }
        },
        
        // --- Modal 相關方法 ---
        openAddModal(date) {
            this.modalType = 'itinerary';
            this.isEditModalMode = false;
            this.currentItemDate = date;
            this.currentItem = {
                id: Date.now(), // 使用時間戳記作為唯一 ID
                category: '景點',
                name: '',
                location: '',
                startTime: '',
                endTime: '',
                duration: '1h00m', // 預設停留 1 小時
                transport: '步行',
                transportDuration: '10m',
                notes: '',
                hoursDisplay: '',
                ticket: '',
            };
            this.isModalOpen = true;
        },
        openEditModal(item, date) {
            this.modalType = 'itinerary';
            this.isEditModalMode = true;
            this.currentItemDate = date;
            // 深度複製以避免直接修改原數據
            this.currentItem = JSON.parse(JSON.stringify(item));
            this.isModalOpen = true;
        },
        openAddItemModal(type, item = null) {
            this.modalType = type;
            this.isEditModalMode = !!item;
            if (item) {
                this.currentItem = JSON.parse(JSON.stringify(item));
            } else if (type === 'shopping') {
                this.currentItem = { id: Date.now(), name: '', category: '伴手禮', notes: '', image: '' };
            } else if (type === 'expense') {
                this.currentItem = { id: Date.now(), name: '', amount: 0, currency: 'HKD', category: '飲食', date: '2026/03/07', payer: '', paymentMethod: '現金', amountTWD: 0 };
            }
            this.isModalOpen = true;
        },
        closeModal() {
            this.isModalOpen = false;
            this.currentItem = null;
            this.currentItemDate = '';
            // 離開時強制儲存一次
            this.updateFirebase();
        },
        saveItem() {
            if (this.modalType === 'itinerary') {
                this.saveItineraryItem();
            } else if (this.modalType === 'shopping') {
                this.saveShoppingItem();
            } else if (this.modalType === 'expense') {
                this.saveExpenseItem();
            }
            this.closeModal();
        },

        // --- 行程 CRUD 邏輯 ---
        saveItineraryItem() {
            const dayIndex = this.itineraryData.findIndex(d => d.date === this.currentItemDate);
            if (dayIndex === -1) return;

            if (this.isEditModalMode) {
                // 編輯現有項目
                const itemIndex = this.itineraryData[dayIndex].items.findIndex(item => item.id === this.currentItem.id);
                if (itemIndex !== -1) {
                    this.itineraryData[dayIndex].items.splice(itemIndex, 1, this.currentItem);
                }
            } else {
                // 新增項目
                this.itineraryData[dayIndex].items.push(this.currentItem);
            }

            // 重新計算時間並排序
            this.recalculateDayTime(this.currentItemDate);
        },
        deleteItineraryItem(date, id) {
            if (confirm('確定要刪除這個行程項目嗎？')) {
                const dayIndex = this.itineraryData.findIndex(d => d.date === date);
                if (dayIndex !== -1) {
                    const itemIndex = this.itineraryData[dayIndex].items.findIndex(item => item.id === id);
                    if (itemIndex !== -1) {
                        this.itineraryData[dayIndex].items.splice(itemIndex, 1);
                        this.recalculateDayTime(date); // 刪除後重新計算時間
                    }
                }
            }
        },
        addDay() {
            const lastDate = this.itineraryData.length > 0 ? this.itineraryData[this.itineraryData.length - 1].date : '2026/03/06';
            const [year, month, day] = lastDate.split('/').map(Number);
            const nextDateObj = new Date(year, month - 1, day + 1); // JS月份是 0-11
            
            const nextDate = `${nextDateObj.getFullYear()}/${String(nextDateObj.getMonth() + 1).padStart(2, '0')}/${String(nextDateObj.getDate()).padStart(2, '0')}`;
            const dayOfWeek = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'][nextDateObj.getDay()];

            this.itineraryData.push({
                date: nextDate,
                dayOfWeek: dayOfWeek,
                weather: 'Unknown',
                items: [
                    { id: Date.now(), category: '景點', name: '新的一天！', location: '請填寫第一個地點', startTime: '09:00', endTime: '10:00', duration: '1h00m', transport: '', transportDuration: '0m', notes: '', hoursDisplay: '' }
                ]
            });
            this.activeDate = nextDate; // 切換到新的日期
            this.updateFirebase();
        },

        // --- 購物與開銷 CRUD 邏輯 ---
        saveShoppingItem() {
            if (this.isEditModalMode) {
                const index = this.shoppingList.findIndex(item => item.id === this.currentItem.id);
                if (index !== -1) this.shoppingList.splice(index, 1, this.currentItem);
            } else {
                this.shoppingList.push(this.currentItem);
            }
        },
        deleteShoppingItem(id) {
            if (confirm('確定要刪除這個購物項目嗎？')) {
                const index = this.shoppingList.findIndex(item => item.id === id);
                if (index !== -1) this.shoppingList.splice(index, 1);
                this.updateFirebase();
            }
        },
        saveExpenseItem() {
            // 確保 TWD 金額計算正確
            if (this.currentItem.currency === 'HKD') {
                this.currentItem.amountTWD = this.currentItem.amount * this.exchangeRate;
            } else {
                this.currentItem.amountTWD = this.currentItem.amount;
            }

            if (this.isEditModalMode) {
                const index = this.expenses.findIndex(item => item.id === this.currentItem.id);
                if (index !== -1) this.expenses.splice(index, 1, this.currentItem);
            } else {
                this.expenses.push(this.currentItem);
            }
        },
        deleteExpenseItem(id) {
            if (confirm('確定要刪除這個開銷記錄嗎？')) {
                const index = this.expenses.findIndex(item => item.id === id);
                if (index !== -1) this.expenses.splice(index, 1);
                this.updateFirebase();
            }
        },

        // --- 時間和排序邏輯 ---
        parseDuration(durationStr) {
            if (!durationStr) return 0;
            const hMatch = durationStr.match(/(\d+)h/);
            const mMatch = durationStr.match(/(\d+)m/);
            const hours = hMatch ? parseInt(hMatch[1]) : 0;
            const minutes = mMatch ? parseInt(mMatch[1]) : 0;
            return hours * 60 + minutes;
        },
        formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        },
        recalculateDayTime(date) {
            const dayData = this.itineraryData.find(d => d.date === date);
            if (!dayData) return;
            
            // 1. 排序：確保行程是按照開始時間排列的
            dayData.items.sort((a, b) => {
                // 使用 startTime 排序
                return a.startTime.localeCompare(b.startTime);
            });

            // 2. 重新計算時間鏈
            dayData.items.forEach((item, index) => {
                let currentItemStartTime;
                
                // 優先使用手動輸入的 startTime
                if (item.startTime && item.startTime.match(/(\d{2}):(\d{2})/)) {
                    const [h, m] = item.startTime.split(':').map(Number);
                    currentItemStartTime = new Date(0, 0, 0, h, m);
                } else if (index === 0) {
                    // 第一個項目且無手動時間，預設 09:00
                    currentItemStartTime = new Date(0, 0, 0, 9, 0);
                    item.startTime = this.formatTime(currentItemStartTime);
                } else {
                    // 如果沒有手動時間，則從前一站的結束時間 + 交通時間開始
                    const prevItem = dayData.items[index - 1];
                    const [prevH, prevM] = prevItem.endTime.split(':').map(Number);
                    
                    let transitionMins = this.parseDuration(item.transportDuration);

                    currentItemStartTime = new Date(0, 0, 0, prevH, prevM + transitionMins);
                    item.startTime = this.formatTime(currentItemStartTime);
                }

                // 3. 計算結束時間
                let durationMins = this.parseDuration(item.duration);
                // 航班/住宿/交通等不需要停留時間
                if (item.category === '航班' || item.category === '住宿' || item.category === '交通') {
                     durationMins = this.parseDuration(item.duration) || 0; // 仍使用 duration 作為時間跨度
                }

                const endH = currentItemStartTime.getHours();
                const endM = currentItemStartTime.getMinutes() + durationMins;
                const endTime = new Date(0, 0, 0, endH, endM);

                item.endTime = this.formatTime(endTime);
            });

            this.updateFirebase();
        },
        recalculateAllTime() {
            // 在載入資料後，對所有日期進行時間重新計算
            this.itineraryData.forEach(day => {
                this.recalculateDayTime(day.date);
            });
        },
        
        // --- 拖曳功能 ---
        handleDragStart(e, index, date) {
            if (!this.isEditMode) return;
            this.draggingDate = date;
            this.draggingItemIndex = index;
            this.isDragging = true;
            // 設置拖曳數據，便於在 drop 時識別
            e.dataTransfer.setData('text/plain', JSON.stringify({ index, date }));
            e.dataTransfer.effectAllowed = 'move';
        },
        handleDragEnd() {
            this.isDragging = false;
            this.draggingDate = null;
            this.draggingItemIndex = null;
        },
        handleDragOver(e, index, date) {
            if (!this.isEditMode || this.draggingDate !== date) return;
            e.preventDefault();
            // 在拖曳經過的元素上添加樣式，但這裡我們只依賴 data 的 isDragging 狀態
        },
        handleDragLeave(e) {
            // 清除拖曳樣式
        },
        handleDrop(e, dropIndex, dropDate) {
            e.preventDefault();
            if (!this.isEditMode || this.draggingDate !== dropDate) return;

            const draggedData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dragIndex = draggedData.index;
            
            if (dragIndex === dropIndex) return;

            const dayData = this.itineraryData.find(d => d.date === dropDate);
            if (!dayData) return;

            const itemToMove = dayData.items.splice(dragIndex, 1)[0];
            dayData.items.splice(dropIndex, 0, itemToMove);

            // 重新計算這天的所有時間
            this.recalculateDayTime(dropDate);
            this.handleDragEnd();
        },

    }
});

app.mount('#app');
</script>

</body>
</html>
