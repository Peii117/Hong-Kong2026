<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰ç¾å¥³éŠé¦™æ¸¯ - è¡Œç¨‹ Web App (Firebase å…±åŒç·¨è¼¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* å®šç¾©æ¸¯å¼æ¥µç°¡é¢¨æ ¼é¡è‰²åŠåœ–ç‰‡åº•è‰²å»¶ä¼¸ */
        :root {
            --color-blue: #4169E1;  /* èŠèŒµè— (Royal Blue) */
            --color-red: #D93025;   /* æ¸¯é¢¨ç´… (Deep Red) */
            --color-bg-ext: #F5F7F8; /* åœ–ç‰‡åº•è‰²å»¶ä¼¸ (æ¥µæ·ºç°è—) */
        }
        
        .bg-royal-blue { background-color: var(--color-blue); }
        .text-royal-blue { color: var(--color-blue); }
        .bg-deep-red { background-color: var(--color-red); }
        .text-deep-red { color: var(--color-red); }
        .bg-extension { background-color: var(--color-bg-ext); }

        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* æ—¥æœŸé¸å–®æ¨£å¼ */
        .date-item .day-of-week { font-size: 1.1rem; }
        .date-item .date-num { font-size: 2rem; line-height: 1; font-weight: 700; }
        
        /* æ¨¡æ…‹è¦–çª—éæ¸¡æ•ˆæœ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* æ©Ÿç¥¨å¡ç‰‡è™›ç·šæ•ˆæœ */
        .ticket-card {
            background-color: white; 
            background-size: 100% 100%;
        }

        .ticket-card::after {
            content: '';
            position: absolute;
            bottom: 40px; /* èª¿æ•´è™›ç·šä½ç½® */
            left: 0;
            right: 0;
            height: 1px;
            background-image: linear-gradient(to right, #ccc 50%, transparent 50%);
            background-size: 15px 1px;
            background-repeat: repeat-x;
        }

        .ticket-cutout-left {
            position: absolute;
            bottom: 35px; /* èˆ‡è™›ç·šå°é½Š */
            left: -10px;
            width: 20px;
            height: 20px;
            background-color: white; /* å…§éƒ¨å¡ç‰‡èƒŒæ™¯è‰² */
            border-radius: 50%;
            z-index: 10;
        }
        .ticket-cutout-right {
            position: absolute;
            bottom: 35px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-color: white; /* å…§éƒ¨å¡ç‰‡èƒŒæ™¯è‰² */
            border-radius: 50%;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-extension min-h-screen">

<div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen">
    
    <header class="relative">
        <div class="h-[250px] overflow-hidden relative bg-extension">
            <img src="Gemini_Generated_Image_y689rxy689rxy689.jpg" 
                 alt="æ¸¯å¼å¾©å¤æ©«å¹…åœ–ç‰‡" 
                 class="w-full h-full object-cover mx-auto absolute top-[-10px]">
        </div>
        
        <div class="h-8 bg-white z-10"></div> 

        <div class="absolute top-0 left-0 right-0 z-20 flex justify-between items-center p-4">
            
            <button @click="toggleEditMode" 
                    :class="{'bg-deep-red text-white shadow-xl': isEditMode, 'bg-white/90 text-gray-700': !isEditMode}" 
                    class="p-2 rounded-full transition duration-300 shadow-md flex items-center text-sm">
                <i :class="isEditMode ? 'fas fa-pen-nib' : 'fas fa-eye'" class="mr-1"></i>
                {{ isEditMode ? 'ç·¨è¼¯ä¸­' : 'ç€è¦½æ¨¡å¼' }}
            </button>

            <button @click="isMenuOpen = !isMenuOpen" 
                    class="p-3 rounded-xl bg-white/90 text-gray-700 shadow-md hover:bg-white transition duration-300">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>
    
    <Transition name="fade">
    <div v-if="isMenuOpen" class="fixed inset-0 z-40">
        <div @click="isMenuOpen = false" class="absolute inset-0 bg-black opacity-40"></div>
        <div class="absolute top-0 right-0 w-64 bg-white h-full shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">åŠŸèƒ½é¸å–®</h3>
            <ul class="space-y-4">
                <li v-for="menu in menus" :key="menu.tab" 
                    @click="setActiveTab(menu.tab)"
                    :class="{'bg-deep-red text-white shadow-md': activeTab === menu.tab, 'text-gray-700 hover:bg-gray-100': activeTab !== menu.tab}"
                    class="p-3 rounded-lg flex items-center cursor-pointer transition duration-200">
                    <i :class="menu.icon" class="w-5 mr-3"></i>
                    <span>{{ menu.name }}</span>
                </li>
            </ul>
        </div>
    </div>
    </Transition>


    <main class="-mt-8 pt-8 relative z-0">
        
        <Transition name="fade" mode="out-in">
        <section v-if="activeTab === 'itinerary'" key="itinerary">
            
            <div class="p-4 pt-0">
                <div class="bg-blue-50 p-3 rounded-xl flex items-center shadow-sm border-l-4 border-royal-blue">
                    <i :class="getWeatherIcon('Sunny')" class="text-orange-400 text-3xl mr-3 flex-shrink-0"></i>
                    <div>
                        <div class="font-bold text-gray-800 flex justify-between items-center">
                            <span>é¦™æ¸¯ç•¶åœ°å¤©æ°£</span>
                            <span class="text-xs font-normal text-red-500">é™é›¨æ©Ÿç‡: 15%</span>
                        </div>
                        <p class="text-sm text-gray-600">æ°£æº«: 22Â°C / é«”æ„Ÿ: 24Â°C</p>
                        <p class="text-xs text-blue-600">å»ºè­°ç©¿è‘—: è–„å¤–å¥—ã€èˆ’é©é•·è¤²</p>
                    </div>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2 px-4">æ¯æ—¥è¡Œç¨‹è¡¨</h2>

            <div class="flex overflow-x-scroll space-x-4 pb-4 px-4 hide-scrollbar">
                <div v-for="day in itineraryData" :key="day.date" 
                     @click="activeDate = day.date"
                     :class="{'bg-royal-blue text-white shadow-xl': activeDate === day.date, 'bg-white border border-gray-200 text-gray-700 hover:bg-gray-50': activeDate !== day.date}" 
                     class="flex-shrink-0 date-item w-16 h-16 flex flex-col items-center justify-center rounded-xl p-1 cursor-pointer transition duration-200">
                    <span class="day-of-week text-sm">{{ day.dayOfWeek }}</span>
                    <span class="date-num">{{ day.date.split('/')[2] }}</span>
                </div>
            </div>
            
            <div class="p-4 pt-0">
                <div v-for="day in itineraryData" :key="day.date">
                    <div v-if="activeDate === day.date">
                        
                        <button v-if="isEditMode" @click="openAddModal(day.date)" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                            <i class="fas fa-plus mr-1"></i> æ–°å¢æ™¯é»/ç¾é£Ÿ/æ´»å‹•
                        </button>
                        
                        <div class="space-y-4">
                            <div v-for="(item, index) in day.items" :key="item.id" 
                                 :class="{'cursor-pointer hover:shadow-lg transition duration-200': isEditMode, 'opacity-70': item.category === 'äº¤é€š'}"
                                 @click="isEditMode && openEditModal(item, day.date)"
                                 
                                 :draggable="isEditMode && item.category !== 'èˆªç­' && item.category !== 'ä½å®¿'" 
                                 @dragstart="handleDragStart($event, index, day.date)"
                                 @dragend="handleDragEnd"
                                 @drop="handleDrop($event, index, day.date)"
                                 @dragover.prevent="handleDragOver($event, index, day.date)"
                                 @dragleave="handleDragLeave"

                                 class="bg-white p-4 rounded-xl shadow-lg border-l-4"
                                 :style="{'border-left-color': item.category === 'èˆªç­' ? '#9CA3AF' : item.category === 'ä½å®¿' ? '#4169E1' : '#D93025'}">
                                
                                <div v-if="index > 0" class="mb-2 text-xs text-gray-500 flex items-center font-mono">
                                    <i :class="getTransportIcon(item.transport)" class="mr-1"></i>
                                    <span class="ml-1">äº¤é€š: {{ item.transportDuration }}</span>
                                </div>
                                
                                <template v-if="item.category === 'èˆªç­'">
                                    <div class="relative bg-gray-100 p-4 rounded-xl ticket-card border border-gray-300 shadow-md">
                                        <div class="flex justify-between items-center mb-3">
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700"><i class="fas fa-plane-departure mr-1"></i> èˆªç­</span>
                                            <span class="text-xl font-mono font-bold text-deep-red">{{ item.flightNumber }}</span>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-2 text-sm text-gray-700">
                                            <div>
                                                <p class="font-bold text-lg">{{ item.startTime }}</p>
                                                <p class="text-xs text-gray-500">{{ item.fromAirport.split(' ')[0] }}</p>
                                            </div>
                                            <div class="text-center">
                                                <i class="fas fa-arrow-right text-royal-blue"></i>
                                                <p class="text-xs text-gray-500">{{ item.duration }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-lg">{{ item.endTime }}</p>
                                                <p class="text-xs text-gray-500">{{ item.toAirport.split(' ')[0] }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="ticket-cutout-left"></div>
                                        <div class="ticket-cutout-right"></div>

                                        <div class="flex justify-between items-center mt-3 pt-3">
                                            <p class="text-xs text-gray-600">{{ item.airline }}</p>
                                            <p class="text-xs text-gray-600">æ©Ÿå‹: {{ item.notes.split(' ')[0] }}</p>
                                        </div>
                                    </div>
                                </template>
                                
                                <template v-else>
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                                                  :class="getCategoryClasses(item.category)">
                                                {{ item.category }}
                                            </span>
                                            <h3 class="text-lg font-bold mt-1 text-gray-800">{{ item.name }}</h3>
                                        </div>
                                        <button @click.stop="openGoogleMaps(item.location)" title="å°èˆª" class="text-royal-blue hover:text-deep-red transition duration-200 flex-shrink-0 p-2">
                                            <i class="fas fa-route fa-lg"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="mt-2 text-sm text-gray-700 space-y-1">
                                        <p><i class="far fa-clock mr-1 text-royal-blue"></i>**{{ item.startTime }}** - **{{ item.endTime }}** <span class="text-xs text-gray-500 ml-1"> (åœç•™ {{ item.duration }})</span></p>
                                        
                                        <p v-if="item.hoursDisplay"><i class="fas fa-info-circle mr-1"></i>ç‡Ÿæ¥­æ™‚é–“/å‚™è¨»: {{ item.hoursDisplay }}</p>
                                        <p v-if="item.ticket"><i class="fas fa-ticket-alt mr-1"></i>é–€ç¥¨: {{ item.ticket }}</p>
                                        <p v-if="item.notes"><i class="fas fa-comment-dots mr-1"></i>ç­†è¨˜: {{ item.notes }}</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section v-else-if="activeTab === 'info'" key="info" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">æ—…è¡Œè³‡è¨Š</h2>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-md border-t-4 border-royal-blue">
                <h3 class="font-bold text-lg mb-2 text-royal-blue"><i class="fas fa-coins mr-1"></i>åŒ¯ç‡æ›ç®— (HKD å…Œ TWD)</h3>
                <p class="text-sm text-gray-500 mb-3">æ¨¡æ“¬å³æ™‚åŒ¯ç‡: HKD 1 â‰ˆ TWD {{ exchangeRate.toFixed(2) }}</p>
                <div class="flex space-x-2 items-center">
                    <input type="number" v-model.number="foreignAmount" placeholder="è¼¸å…¥ HKD" class="w-1/2 p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    <span class="text-lg font-bold text-deep-red">=</span>
                    <div class="w-1/2 p-2 bg-white border rounded-md font-bold text-gray-700">
                        {{ (foreignAmount * exchangeRate).toFixed(2) }} TWD
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-deep-red">
                <h3 class="font-bold text-lg mb-2 text-deep-red"><i class="fas fa-plane mr-2"></i>èˆªç­è³‡è¨Š</h3>
                <div v-for="(flight, type) in flightInfo" :key="type" class="mb-4 pb-2 border-b last:border-b-0">
                    <p class="font-semibold text-gray-700">{{ type === 'to' ? 'å»ç¨‹' : 'å›ç¨‹' }}</p>
                    <div class="text-sm grid grid-cols-2 gap-x-4">
                        <p>èˆªç·š: <span class="font-mono">{{ flight.from }} - {{ flight.to }}</span></p>
                        <p>èˆªç­: <span class="font-mono">{{ flight.number }}</span></p>
                        <p>èµ·é£›: **{{ flight.depTime }}**</p>
                        <p>æŠµé”: **{{ flight.arrTime }}**</p>
                        <p class="col-span-2">é£›è¡Œæ™‚é–“: {{ flight.duration }} / æ©Ÿå‹: {{ flight.model }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-royal-blue">
                <h3 class="font-bold text-lg mb-2 text-royal-blue"><i class="fas fa-hotel mr-2"></i>ä½å®¿è³‡è¨Š</h3>
                <div v-for="hotel in accommodationInfo" :key="hotel.name" class="mb-4 pb-2 border-b last:border-b-0">
                    <p class="font-bold text-md">{{ hotel.name }}</p>
                    <p class="text-sm text-gray-600">æ—¥æœŸ: {{ hotel.dates }}</p>
                    <p class="text-sm text-gray-600">åœ°å€: {{ hotel.address }}</p>
                    <button @click="openGoogleMaps(hotel.address)" class="text-xs text-deep-red hover:underline block mt-1"><i class="fas fa-route mr-1"></i>å°èˆªè‡³é£¯åº—</button>
                </div>
                <p class="text-xs text-gray-400 mt-2">ï¼ˆæ­¤è³‡è¨Šéœ€æ‰‹å‹•ä¿®æ”¹ç¨‹å¼ç¢¼ï¼‰</p>
            </div>
            
        </section>
        
        <section v-else-if="activeTab === 'food'" key="food" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">ç¾é£Ÿæ¸…å–® (å¾…é–‹ç™¼)</h2>
            <div class="bg-yellow-50 p-4 rounded-xl text-yellow-800">
                æ­¤é é¢æœªä¾†å¯æ•´åˆæ‚¨æ‰€æœ‰æƒ³åƒçš„é¤å»³åˆ—è¡¨å’Œç­†è¨˜ï¼
            </div>
        </section>

        <section v-else-if="activeTab === 'shopping'" key="shopping" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">è³¼ç‰©æ¸…å–®</h2>
            
            <button v-if="isEditMode" @click="openAddItemModal('shopping')" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                <i class="fas fa-plus mr-1"></i> æ–°å¢è³¼ç‰©é …ç›®
            </button>

            <div class="mb-4 flex space-x-2">
                <button @click="selectedShoppingCategory = 'all'" :class="{'bg-deep-red text-white': selectedShoppingCategory === 'all', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== 'all'}" class="px-3 py-1 rounded-full text-sm">å…¨éƒ¨</button>
                <button @click="selectedShoppingCategory = 'ä¼´æ‰‹ç¦®'" :class="{'bg-deep-red text-white': selectedShoppingCategory === 'ä¼´æ‰‹ç¦®', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== 'ä¼´æ‰‹ç¦®'}" class="px-3 py-1 rounded-full text-sm">ä¼´æ‰‹ç¦®</button>
                <button @click="selectedShoppingCategory = 'ç´€å¿µå“'" :class="{'bg-deep-red text-white': selectedShoppingCategory === 'ç´€å¿µå“', 'bg-gray-200 text-gray-700': selectedShoppingCategory !== 'ç´€å¿µå“'}" class="px-3 py-1 rounded-full text-sm">ç´€å¿µå“</button>
            </div>

            <div class="space-y-4">
                <div v-for="(item, index) in filteredShoppingList" :key="item.id" 
                     @click="isEditMode && openAddItemModal('shopping', item)"
                     :class="{'cursor-pointer hover:shadow-lg transition duration-200': isEditMode}"
                     class="bg-white p-4 rounded-xl shadow-md flex items-center border-l-4 border-royal-blue">
                    
                    <div class="w-16 h-16 bg-gray-100 rounded-lg mr-4 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-camera text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">{{ item.name }}</p>
                        <p class="text-xs font-semibold text-deep-red">{{ item.category }}</p>
                        <p v-if="item.notes" class="text-sm text-gray-500">å‚™è¨»: {{ item.notes }}</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section v-else-if="activeTab === 'expense'" key="expense" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">èŠ±è²»è¨˜éŒ„</h2>
            
            <div class="bg-royal-blue text-white p-4 rounded-xl mb-4 shadow-lg text-center">
                <p class="text-sm font-semibold">ç¸½èŠ±è²» (TWD)</p>
                <p class="text-4xl font-bold">{{ totalExpenseTWD.toLocaleString(undefined, { maximumFractionDigits: 0 }) }}</p>
            </div>

            <button v-if="isEditMode" @click="openAddItemModal('expense')" class="w-full bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl mb-4 hover:bg-green-200 transition duration-200 font-semibold">
                <i class="fas fa-plus mr-1"></i> æ–°å¢é–‹éŠ·
            </button>

            <div class="space-y-3">
                <div v-for="(item, index) in expenses" :key="item.id" 
                     @click="isEditMode && openAddItemModal('expense', item)"
                     :class="{'cursor-pointer hover:shadow-md transition': isEditMode}"
                     class="bg-white p-3 rounded-xl shadow-sm border-l-4"
                     :style="{'border-left-color': item.paymentMethod === 'ç¾é‡‘' ? '#10B981' : '#3B82F6'}">
                    <div class="flex justify-between items-center">
                        <div class="flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">{{ item.category }}</span>
                            <p class="font-bold text-gray-800 mt-1">{{ item.name }}</p>
                            <p class="text-xs text-gray-500">
                                {{ item.date }} | {{ item.paymentMethod }}
                                <span v-if="item.payer" class="ml-2 font-semibold text-deep-red">({{ item.payer }})</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-deep-red">{{ item.amount.toLocaleString() }} {{ item.currency }}</p>
                            <p class="text-xs text-gray-500">â‰ˆ {{ item.amountTWD.toLocaleString(undefined, { maximumFractionDigits: 0 }) }} TWD</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        </Transition>
        
        <div class="h-10"></div>

    </main>

    <Transition name="fade">
    <div v-if="isModalOpen && currentItem" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4">{{ modalTitle }}</h3>
            
            <form @submit.prevent="saveItem" class="space-y-4">
                
                <template v-if="modalType === 'itinerary'">
                    <div class="text-sm text-gray-600">æ—¥æœŸ: {{ currentItemDate }}</div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">åç¨±/æ¨™é¡Œ</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue" :readonly="currentItem.category !== 'äº¤é€š' && isPlaceSelected">
                        <p v-if="currentItem.category !== 'äº¤é€š' && isPlaceSelected" class="text-xs text-gray-500 mt-1">åç¨±å·²ç”± Google åœ°åœ–é–å®šã€‚å¦‚éœ€æ›´æ”¹ï¼Œè«‹é‡æ–°é¸å–åœ°é»ã€‚</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-1">åˆ†é¡</label>
                        <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue" :disabled="isEditModalMode && (currentItem.category === 'èˆªç­' || currentItem.category === 'ä½å®¿')">
                            <option v-for="cat in categories.filter(c => c !== 'èˆªç­')" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>

                    <div v-if="currentItem.category !== 'äº¤é€š'">
                        <label class="block text-sm font-semibold mb-1">åœ°é»/åœ°å€ (é–‹å§‹è¼¸å…¥æœƒè‡ªå‹•æœå°‹é¦™æ¸¯åœ°é»)</label>
                        <input type="text" id="location-autocomplete" v-model="currentItem.location" placeholder="ä¾‹å¦‚: è¿ªå£«å°¼æ¨‚åœ’" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-royal-blue space-y-3">
                        <h4 class="font-bold text-royal-blue text-sm">æ’ç¨‹è¨­å®š (HH:MM)</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold mb-1">æ‰‹å‹•é–‹å§‹æ™‚é–“ (HH:MM)</label>
                                <input type="text" v-model="currentItem.startTime" placeholder="ä¾‹å¦‚: 10:30" 
                                       pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                                       class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <p class="text-xs text-gray-500 mt-1">ç•™ç©ºå°‡è‡ªå‹•è¨ˆç®—</p>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold mb-1">åœç•™æ™‚é–“ (ä¾‹å¦‚: 2h30m)</label>
                                <input type="text" v-model="currentItem.duration" required 
                                       placeholder="ä¾‹å¦‚: 1h30m"
                                       pattern="(\d+h)?(\d+m)?"
                                       class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4" v-if="isEditModalMode || currentItem.id !== 1">
                            <div>
                                <label class="block text-xs font-semibold mb-1">äº¤é€šæ–¹å¼ (ä¾†è‡ªå‰ä¸€ç«™)</label>
                                <select v-model="currentItem.transport" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                                    <option value="æ­¥è¡Œ">æ­¥è¡Œ</option>
                                    <option value="å¤§çœ¾é‹è¼¸">å¤§çœ¾é‹è¼¸</option>
                                    <option value="é–‹è»Š">è¨ˆç¨‹è»Š/é–‹è»Š</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">äº¤é€šæ™‚é–“ (ä¾‹å¦‚: 30m, 1h)</label>
                                <input type="text" v-model="currentItem.transportDuration" required 
                                       placeholder="ä¾‹å¦‚: 25m"
                                       pattern="(\d+h)?(\d+m)?"
                                       class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3 mt-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">é–€ç¥¨/è²»ç”¨</label>
                            <input type="text" v-model="currentItem.ticket" placeholder="ä¾‹å¦‚: HKD $300 (å·²è³¼)" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">ç‡Ÿæ¥­æ™‚é–“è³‡è¨Š (Google Maps è‡ªå‹•å¡«å…¥/æ‰‹å‹•ä¿®æ”¹)</label>
                            <textarea v-model="currentItem.hoursDisplay" rows="2" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue"></textarea>
                            <p class="text-xs text-gray-500 mt-1">æ­¤æ¬„ä½åƒ…ä¾›åƒè€ƒï¼Œä¸å½±éŸ¿æ’ç¨‹è¨ˆç®—ã€‚</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">å€‹äººç­†è¨˜/æé†’</label>
                            <textarea v-model="currentItem.notes" rows="2" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue"></textarea>
                        </div>
                    </div>

                    <p class="text-xs text-red-500 mt-2">æ³¨æ„ï¼šèˆªç­/ä½å®¿ç‚ºå›ºå®šé …ç›®ï¼Œä¸å¯æ‹–æ›³ã€‚äº¤é€šè¡Œç¨‹ä¸éœ€åœç•™æ™‚é–“ (Duration)ã€‚</p>

                </template>

                <template v-else-if="modalType === 'shopping'">
                    <div>
                        <label class="block text-sm font-semibold mb-1">å•†å“åç¨±</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">åˆ†é¡</label>
                        <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                            <option value="ä¼´æ‰‹ç¦®">ä¼´æ‰‹ç¦®</option>
                            <option value="ç´€å¿µå“">ç´€å¿µå“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">å‚™è¨»/åœ°é»</label>
                        <input type="text" v-model="currentItem.notes" placeholder="ä¾‹å¦‚: å°–æ²™å’€åº—" class="w-full p-2 border rounded-md focus:ring-royal-blue focus:border-royal-blue">
                    </div>
                </template>
                
                <template v-else-if="modalType === 'expense'">
                    <div>
                        <label class="block text-sm font-semibold mb-1">åç¨±/ç”¨é€”</label>
                        <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">é¡åˆ¥</label>
                            <select v-model="currentItem.category" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="äº¤é€š">äº¤é€š</option><option value="é£²é£Ÿ">é£²é£Ÿ</option><option value="è³¼ç‰©">è³¼ç‰©</option>
                                <option value="ä½å®¿">ä½å®¿</option><option value="é–€ç¥¨">é–€ç¥¨</option><option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">æ—¥æœŸ</label>
                            <input type="text" v-model="currentItem.date" placeholder="ä¾‹å¦‚: 2026/3/7" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold mb-1">é‡‘é¡ (ç•¶åœ°è²¨å¹£)</label>
                            <input type="number" step="0.01" v-model.number="currentItem.amount" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">è²¨å¹£</label>
                            <select v-model="currentItem.currency" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="HKD">HKD</option><option value="TWD">TWD</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">ä»˜æ¬¾äºº</label>
                            <select v-model="currentItem.payer" required class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="æ²›æ™´">æ²›æ™´</option>
                                <option value="èŠ³æ™¨">èŠ³æ™¨</option>
                                <option value="çŸå¦¤">çŸå¦¤</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">ä»˜æ¬¾æ–¹å¼</label>
                            <select v-model="currentItem.paymentMethod" class="w-full p-2 border rounded-md focus:ring-deep-red focus:border-deep-red">
                                <option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option><option value="é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
                            </select>
                        </div>
                    </div>
                    
                </template>
                
                <div v-if="isEditModalMode" class="flex justify-start pt-2">
                    <button type="button" @click="showDeleteConfirm = true" class="px-3 py-1 bg-red-100 text-deep-red font-semibold rounded-lg hover:bg-red-200 transition text-sm">
                        <i class="fas fa-trash-alt mr-1"></i> åˆªé™¤æ­¤é …ç›®
                    </button>
                </div>

                <div v-if="showDeleteConfirm" class="mt-4 p-3 bg-red-50 border-l-4 border-deep-red rounded-lg">
                    <p class="text-sm font-semibold mb-2">ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—?</p>
                    <div class="flex justify-end space-x-2">
                        <button type="button" @click="showDeleteConfirm = false" class="text-xs text-gray-600 px-3 py-1 border rounded">å–æ¶ˆ</button>
                        <button type="button" @click="deleteItem" class="text-xs text-white bg-deep-red px-3 py-1 rounded">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                    <button type="button" @click="closeModal" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-royal-blue text-white rounded-lg hover:bg-blue-700">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    </Transition>
</div>

<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap">
</script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // --- ğŸš¨ æ­¥é©Ÿ 2.1: æ›¿æ›ç‚ºæ‚¨çš„ Firebase é…ç½® (å·²æ›¿æ›) ğŸš¨ ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-gOroKPdB2Ao0LDKNC1uEeTDcTRaAeao",
      authDomain: "hong-kong-2026.firebaseapp.com",
      databaseURL: "https://hong-kong-2026-default-rtdb.firebaseio.com",
      projectId: "hong-kong-2026",
      storageBucket: "hong-kong-2026.firebasestorage.app",
      messagingSenderId: "302735565930",
      appId: "1:302735565930:web:f07ce32094f2e412865613",
      measurementId: "G-3D4GNSSBQ3" // é›–ç„¶ä¸ç›´æ¥ç”¨æ–¼ Realtime DBï¼Œä½†ä¿ç•™æ‚¨çš„å®Œæ•´é…ç½®
    };

    // åˆå§‹åŒ– Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();
    
    // å®šç¾©è³‡æ–™åº«è·¯å¾‘ (æ‰€æœ‰å…±åŒç·¨è¼¯è€…å…±ç”¨æ­¤è·¯å¾‘)
    const DB_ROOT_REF = database.ref('hongkongTripV5'); 
    
    // --- Vue App & è¼”åŠ©å‡½å¼ (åƒ…ä¿®æ”¹è³‡æ–™è®€å¯«) ---
    
    const { createApp, ref, computed, watch, nextTick, onMounted } = Vue
    
    // å»ºç«‹ä¸€å€‹ä¾› Google Maps å…¨åŸŸå­˜å–çš„ç‰©ä»¶
    window.appFunctions = {};

    // --- Google Maps å…¨åŸŸå›èª¿å‡½æ•¸ (KEEP) ---
    function initMap() {
        console.log("Google Maps API è¼‰å…¥å®Œæˆã€‚");
        window.initAutocomplete = () => {
            const input = document.getElementById('location-autocomplete');
            if (!input) return; 
            if (!input.classList.contains('autocomplete-initialized')) {
                 const options = {
                    componentRestrictions: { country: "hk" },
                    fields: ["name", "formatted_address", "opening_hours"],
                 };
                 const autocomplete = new google.maps.places.Autocomplete(input, options);
                 input.classList.add('autocomplete-initialized'); 

                 autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.name || !place.formatted_address) return;

                    let hoursString = 'ç„¡å·²çŸ¥ç‡Ÿæ¥­æ™‚é–“';
                    if (place.opening_hours && place.opening_hours.weekday_text) {
                        hoursString = place.opening_hours.weekday_text.join(' | ');
                    }
                    window.appFunctions.updatePlaceDetails(
                        place.name, 
                        place.formatted_address, 
                        hoursString
                    );
                });
            }
        };
    }
    
    // --- è¼”åŠ©å‡½å¼ï¼šæ™‚é–“èˆ‡æŒçºŒæ™‚é–“è™•ç† (KEEP) ---
    function parseDurationToMinutes(durationStr) {
        if (!durationStr || typeof durationStr !== 'string') return 0;
        const hourMatch = durationStr.match(/(\d+)h/i);
        const minuteMatch = durationStr.match(/(\d+)m/i);
        let totalMinutes = 0;
        if (hourMatch) totalMinutes += parseInt(hourMatch[1], 10) * 60;
        if (minuteMatch) totalMinutes += parseInt(minuteMatch[1], 10);
        return totalMinutes;
    }

    function addMinutesToTime(timeStr, minutesToAdd) {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':').map(Number);
        const tempDate = new Date(2000, 0, 1, hours, minutes);
        tempDate.setMinutes(tempDate.getMinutes() + minutesToAdd);
        const newHours = tempDate.getHours().toString().padStart(2, '0');
        const newMinutes = tempDate.getMinutes().toString().padStart(2, '0');
        return `${newHours}:${newMinutes}`;
    }

    function isValidTimeFormat(timeStr) {
        if (!timeStr) return false;
        return /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(timeStr);
    }
    
    // --- æ ¸å¿ƒæ™‚é–“é€£å‹•è¨ˆç®—å¼•æ“ (KEEP) ---
    function computeDayTimes(day) {
        let currentTime = null;
        const defaultStartTime = '09:00'; 
        const firstManualItem = day.items.find(item => isValidTimeFormat(item.startTime) && item.category !== 'èˆªç­');
        
        if (firstManualItem) {
             currentTime = firstManualItem.startTime;
        } else {
             const firstCalculatableItem = day.items.find(item => item.category !== 'èˆªç­' && item.category !== 'ä½å®¿');
             if(firstCalculatableItem) {
                currentTime = defaultStartTime;
             }
        }

        day.items.forEach((item, index) => {
            if (item.category === 'èˆªç­' || item.category === 'ä½å®¿') {
                if(item.startTime && item.duration) {
                     item.endTime = addMinutesToTime(item.startTime, parseDurationToMinutes(item.duration));
                }
                // å¦‚æœæ˜¯ä½å®¿/èˆªç­ï¼Œä¸”è¨­å®šäº†çµæŸæ™‚é–“ï¼Œå‰‡å°‡ä¸‹ä¸€ç«™çš„é–‹å§‹æ™‚é–“æ¨é²åˆ°çµæŸæ™‚é–“ + 30 åˆ†é˜
                if(item.endTime && (currentTime === null || item.endTime > currentTime)) {
                    // å¦‚æœä¸‹ä¸€ç«™æ²’æœ‰æ‰‹å‹•æŒ‡å®šæ™‚é–“ï¼Œå‰‡å¾æ­¤è™•å¾€å¾Œæ¨ 30 åˆ†é˜
                    if(!day.items[index + 1] || !isValidTimeFormat(day.items[index + 1].startTime)){
                        currentTime = addMinutesToTime(item.endTime, 30); 
                    }
                }
                return; 
            }

            let travelTimeInMinutes = 0;
            if (index > 0 && item.transportDuration) {
                travelTimeInMinutes = parseDurationToMinutes(item.transportDuration);
            }
            
            let itemStartTime = null;

            // å¦‚æœä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥äº†æ™‚é–“
            if (isValidTimeFormat(item.startTime) && index >= day.items.findIndex(i => i.id === item.id)) {
                itemStartTime = item.startTime;
                currentTime = itemStartTime; 
            } else if (currentTime !== null) {
                itemStartTime = addMinutesToTime(currentTime, travelTimeInMinutes);
            } else {
                itemStartTime = defaultStartTime;
            }

            if (itemStartTime) {
                const stayDurationInMinutes = parseDurationToMinutes(item.duration);
                item.startTime = itemStartTime;
                item.endTime = addMinutesToTime(item.startTime, stayDurationInMinutes);
                currentTime = item.endTime; 
            } else {
                item.startTime = '';
                item.endTime = '';
            }

            if (item.category === 'äº¤é€š' && item.transportDuration) {
                item.endTime = addMinutesToTime(item.startTime, parseDurationToMinutes(item.transportDuration));
                item.duration = item.transportDuration; 
                currentTime = item.endTime;
            }
        });
    }

    // --- Vue App Setup ---
    createApp({
        setup() {
            // è®€å– UI ç‹€æ…‹ (å„ªå…ˆè®€å– LocalStorageï¼Œå¦‚æœæ²’æœ‰æ‰ç”¨ Firebase é è¨­å€¼)
            const getInitialState = (key, defaultValue) => {
                const localValue = localStorage.getItem(key);
                if (localValue !== null) {
                    try {
                        // å˜—è©¦è§£æ JSONï¼Œå¦‚æœå¤±æ•—å‰‡ç›´æ¥è¿”å›å­—ä¸²æˆ–é è¨­å€¼
                        return JSON.parse(localValue);
                    } catch (e) {
                        return localValue;
                    }
                }
                return defaultValue; 
            };

            const isEditMode = ref(getInitialState('isEditMode', false));
            const activeTab = ref(getInitialState('activeTab', 'itinerary'));
            const activeDate = ref(getInitialState('activeDate', '2026/3/6'));
            const isMenuOpen = ref(false);
            const selectedShoppingCategory = ref('all'); 
            const categories = ['æ™¯é»', 'ä½å®¿', 'ç¾é£Ÿ', 'è³¼ç‰©', 'äº¤é€š', 'å…¶ä»–'];
            
            // æ¨¡æ…‹è¦–çª—ç‹€æ…‹ (æœ¬åœ°ç‹€æ…‹)
            const isModalOpen = ref(false);
            const isEditModalMode = ref(false); 
            const showDeleteConfirm = ref(false);
            const modalTitle = ref('');
            const modalType = ref('');
            const currentItem = ref(null);
            const currentItemDate = ref('');
            const isPlaceSelected = ref(false);
            
            // æ‹–æ›³ç›¸é—œç‹€æ…‹ (æœ¬åœ°ç‹€æ…‹)
            const dragStartIndex = ref(-1); 
            const draggingDate = ref(''); 

            // åŒ¯ç‡æ¨¡æ“¬
            const exchangeRate = 4.02; 
            const foreignAmount = ref(100); 

            // --- é è¨­æ•¸æ“š (åƒ…åœ¨ Firebase ç„¡è³‡æ–™æ™‚ä½¿ç”¨) ---
            const defaultItinerary = [
                // ... (é è¨­è¡Œç¨‹æ•¸æ“šä¿æŒä¸è®Šï¼Œç•¥) ...
                {
                    date: '2026/3/6', dayOfWeek: 'FRI',
                    items: [
                        { id: 1, category: 'èˆªç­', name: 'å»ç¨‹èˆªç­', flightNumber: 'JX233', fromAirport: 'TPE T1', toAirport: 'HKG T1', startTime: '08:00', endTime: '10:10', duration: '2h10m', airline: 'æ˜Ÿå®‡èˆªç©º', notes: 'ç©ºä¸­å·´å£«A321neo', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´', transport: 'èˆªç­', transportDuration: '0m' }, 
                        { id: 2, category: 'äº¤é€š', name: 'è¨ˆç¨‹è»Šè‡³è¿ªå£«å°¼', startTime: '10:40', duration: '30m', endTime: '11:10', transport: 'é–‹è»Š', transportDuration: '30m', notes: 'æ©Ÿå ´ç›´é”è¿ªå£«å°¼', location: 'é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’', hoursDisplay: '' },
                        { id: 3, category: 'æ™¯é»', name: 'é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’', startTime: '11:10', duration: '5h30m', endTime: '16:40', hoursDisplay: '10:30-20:30', ticket: 'å·²è³¼ç¥¨', transportDuration: '5m', transport: 'æ­¥è¡Œ', notes: 'æ™šä¸Šçœ‹éŠæ¨‚åœ’ç…™ç«', location: 'é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’' },
                        { id: 4, category: 'ä½å®¿', name: 'è¿ªå£«å°¼å¥½èŠå¡¢é…’åº—', startTime: '17:00', duration: '1h', endTime: '18:00', hoursDisplay: '15:00 Check-in', transportDuration: '20m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'ç±³å¥‡èˆ‡å¥½å‹æµ·æ™¯å®¢æˆ¿', location: 'è¿ªå£«å°¼å¥½èŠå¡¢é…’åº—' },
                    ]
                },
                {
                    date: '2026/3/7', dayOfWeek: 'SAT',
                    items: [
                        { id: 5, category: 'äº¤é€š', name: 'é£¯åº—æ¥é§è»Šè½‰åœ°éµ', startTime: '08:30', duration: '1h15m', endTime: '09:45', transportDuration: '10m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'è¿ªå£«å°¼ç·š->æ¬£æ¾³->é¦™æ¸¯ç«™', location: 'é¦™æ¸¯é‡‘åŸŸå‡æ—¥é…’åº—', hoursDisplay: '' },
                        { id: 6, category: 'ä½å®¿', name: 'é¦™æ¸¯é‡‘åŸŸå‡æ—¥é…’åº—', startTime: '09:45', duration: '30m', endTime: '10:15', hoursDisplay: 'å¯„æ”¾è¡Œæ', transportDuration: '5m', transport: 'æ­¥è¡Œ', notes: 'N5/P3å‡ºå£æœ‰é›»æ¢¯', location: 'é¦™æ¸¯é‡‘åŸŸå‡æ—¥é…’åº—' },
                        { id: 7, category: 'ç¾é£Ÿ', name: 'å°–æ²™å’€ç¾é£Ÿè³¼ç‰©', startTime: '10:15', duration: '2h0m', endTime: '12:15', hoursDisplay: 'å½ˆæ€§', transportDuration: '10m', transport: 'æ­¥è¡Œ', notes: 'é–‹å§‹åƒç¾é£ŸåŠè³¼ç‰©', location: 'å°–æ²™å’€' },
                        { id: 8, category: 'æ™¯é»', name: 'å±±é ‚çºœè»Š (ä¸­ç’°)', startTime: '12:30', duration: '3h0m', endTime: '15:30', hoursDisplay: '7:00-22:00', ticket: 'ä¾†å›ç¥¨', transportDuration: '15m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'ä¸­ç’°èµ°åˆ°ä¸­åœ’èŠ±é“æ­çºœè»Š', location: 'å±±é ‚çºœè»Šç¸½ç«™' },
                        { id: 9, category: 'æ™¯é»', name: 'ç›§å‰é“è§€æ™¯å°', startTime: '15:45', duration: '2h0m', endTime: '17:45', hoursDisplay: 'å…¨å¤©', ticket: 'ç„¡', transportDuration: '15m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'çœ‹é¦™æ¸¯å¤œæ™¯', location: 'ç›§å‰é“è§€æ™¯å°' },
                        { id: 10, category: 'å…¶ä»–', name: 'è˜­æ¡‚åŠ', startTime: '18:00', duration: '3h0m', endTime: '21:00', hoursDisplay: '18:00-æ·±å¤œ', transportDuration: '15m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'å›é£¯åº—å‰å–é…’', location: 'è˜­æ¡‚åŠ' },
                    ]
                },
                {
                    date: '2026/3/8', dayOfWeek: 'SUN',
                    items: [
                        { id: 11, category: 'è³¼ç‰©', name: 'å¸‚å€è²·è›‹å¡”ä¼´æ‰‹ç¦®', startTime: '10:00', duration: '1h0m', endTime: '11:00', hoursDisplay: '10:00-12:00', transportDuration: '5m', transport: 'æ­¥è¡Œ', notes: 'æ³°æ˜Œé¤…å®¶', location: 'å°–æ²™å’€' },
                        { id: 12, category: 'äº¤é€š', name: 'æ©Ÿå ´å¿«ç·š', startTime: '11:15', duration: '45m', endTime: '12:00', transportDuration: '15m', transport: 'å¤§çœ¾é‹è¼¸', notes: 'å°–æ²™å˜´>é¦™æ¸¯ç«™>æ©Ÿå ´å¿«ç·š', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´', hoursDisplay: '' },
                        { id: 13, category: 'èˆªç­', name: 'å›ç¨‹èˆªç­', flightNumber: 'CI910', fromAirport: 'HKG T1', toAirport: 'TPE T1', startTime: '14:04', endTime: '15:50', duration: '1h46m', airline: 'ä¸­è¯èˆªç©º', notes: 'ç™»æ©Ÿå‰ä¸‰å°æ™‚æŠµé”æ©Ÿå ´', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´', transport: 'èˆªç­', transportDuration: '0m' },
                    ]
                },
            ];

            const initialData = {
                itinerary: defaultItinerary,
                flightInfo: {
                    to: { from: 'TPE', to: 'HKG', number: 'JX233', depTime: '08:00', arrTime: '10:10', duration: '2h10m', model: 'A321neo' },
                    back: { from: 'HKG', to: 'TPE', number: 'CI910', depTime: '14:04', arrTime: '15:50', duration: '1h46m', model: 'B777-300ER' }
                },
                accommodationInfo: [
                    { name: 'è¿ªå£«å°¼å¥½èŠå¡¢é…’åº—', dates: '2026/3/6 - 2026/3/7', address: 'å¤§å¶¼å±±é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’', mapLink: '...' },
                    { name: 'é¦™æ¸¯é‡‘åŸŸå‡æ—¥é…’åº—', dates: '2026/3/7 - 2026/3/8', address: 'é¦™æ¸¯å°–æ²™å’€å½Œæ•¦é“50è™Ÿ', mapLink: '...' }
                ],
                shopping: [],
                expenses: []
            };

            const menus = [
                { tab: 'itinerary', name: 'è¡Œç¨‹è¡¨', icon: 'fas fa-list-check' },
                { tab: 'info', name: 'æ—…è¡Œè³‡è¨Š', icon: 'fas fa-info-circle' },
                { tab: 'food', name: 'ç¾é£Ÿæ¸…å–®', icon: 'fas fa-utensils' },
                { tab: 'shopping', name: 'è³¼ç‰©æ¸…å–®', icon: 'fas fa-shopping-bag' },
                { tab: 'expense', name: 'èŠ±è²»è¨˜éŒ„', icon: 'fas fa-hand-holding-dollar' },
            ];
            
            const payers = ['æ²›æ™´', 'èŠ³æ™¨', 'çŸå¦¤'];

            // --- Firebase æ•¸æ“šç‹€æ…‹ (åˆå§‹åŒ–ç‚ºç©ºæˆ–é è¨­) ---
            const itineraryData = ref(initialData.itinerary);
            const flightInfo = ref(initialData.flightInfo); 
            const accommodationInfo = ref(initialData.accommodationInfo); 
            const shoppingList = ref(initialData.shopping); 
            const expenses = ref(initialData.expenses);     

            // --- å¯¦ç¾ Firebase æ•¸æ“šåŒæ­¥ ---
            
            onMounted(() => {
                // 1. ç›£è½ Firebase æ ¹ç›®éŒ„æ•¸æ“š
                firebase.database().ref('hongkongTripV5').on('value', (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data) {
                        // å¦‚æœ Firebase æœ‰è³‡æ–™ï¼Œæ›´æ–° Vue ç‹€æ…‹
                        itineraryData.value = data.itinerary || initialData.itinerary;
                        flightInfo.value = data.flightInfo || initialData.flightInfo;
                        accommodationInfo.value = data.accommodationInfo || initialData.accommodationInfo;
                        shoppingList.value = data.shopping || initialData.shopping;
                        expenses.value = data.expenses || initialData.expenses;
                        
                        // ç¢ºä¿æ™‚é–“é‡æ–°è¨ˆç®— (Firebase æ•¸æ“šå¯èƒ½æ²’æœ‰è¨ˆç®—å¥½çš„ endTime)
                        itineraryData.value.forEach(day => computeDayTimes(day));

                        // ç¢ºä¿ UI ç‹€æ…‹åŒæ­¥ (å¾ Firebase è®€å–)
                        if(data.uiState) {
                           // é€™è£¡ä½¿ç”¨ Firebase çš„å€¼è¦†è“‹ LocalStorageï¼Œå¯¦ç¾å…±åŒç·¨è¼¯çš„ UI åŒæ­¥
                           isEditMode.value = data.uiState.isEditMode || false;
                           activeTab.value = data.uiState.activeTab || 'itinerary';
                           activeDate.value = data.uiState.activeDate || '2026/3/6';
                        }
                        
                    } else {
                         // å¦‚æœ Firebase æ ¹ç›®éŒ„æ˜¯ç©ºçš„ï¼Œå‰‡ä¸Šå‚³é è¨­æ•¸æ“š
                         saveAllData(initialData); 
                    }
                });
            });

            // è¼”åŠ©å‡½æ•¸ï¼šå°‡æ‰€æœ‰è³‡æ–™å¯«å› Firebase
            const saveAllData = (dataToSave) => {
                // ç‚ºäº†é¿å…é‡è¤‡å¯«å…¥ UI ç‹€æ…‹ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ UI ç‹€æ…‹æ˜¯ç•¶å‰æœ€æ–°çš„
                 const finalData = {
                    ...dataToSave,
                    uiState: {
                        isEditMode: isEditMode.value,
                        activeTab: activeTab.value,
                        activeDate: activeDate.value,
                    }
                 };

                firebase.database().ref('hongkongTripV5').set(finalData).catch(error => {
                    console.error("Firebase å¯«å…¥å¤±æ•—:", error);
                    alert("è³‡æ–™åŒæ­¥åˆ°é›²ç«¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®šã€‚");
                });
            };

            // è¼”åŠ©å‡½æ•¸ï¼šè§¸ç™¼ä¿å­˜ (å°‡æ‰€æœ‰ ref çš„ .value çµ„åˆæˆå–®ä¸€ç‰©ä»¶ä¸¦å¯«å›)
            const triggerSave = () => {
                const dataToSave = {
                    itinerary: itineraryData.value,
                    flightInfo: flightInfo.value,
                    accommodationInfo: accommodationInfo.value,
                    shopping: shoppingList.value,
                    expenses: expenses.value,
                };
                saveAllData(dataToSave);
            };

            // ç›£è½ UI ç‹€æ…‹è®ŠåŒ–ä¸¦åŒæ­¥åˆ° LocalStorage (ç”¨æ–¼å–®ç¨ä½¿ç”¨è€…ç‹€æ…‹) å’Œ Firebase
            watch(isEditMode, (newVal) => { 
                localStorage.setItem('isEditMode', JSON.stringify(newVal)); 
                firebase.database().ref('hongkongTripV5/uiState/isEditMode').set(newVal); 
            });
            watch(activeTab, (newVal) => { 
                localStorage.setItem('activeTab', JSON.stringify(newVal)); 
                firebase.database().ref('hongkongTripV5/uiState/activeTab').set(newVal); 
            });
            watch(activeDate, (newVal) => { 
                localStorage.setItem('activeDate', JSON.stringify(newVal)); 
                firebase.database().ref('hongkongTripV5/uiState/activeDate').set(newVal); 
            });
            
            // --- Computed å±¬æ€§ (KEEP) ---
            const filteredShoppingList = computed(() => {
                if (selectedShoppingCategory.value === 'all') {
                    return shoppingList.value;
                }
                return shoppingList.value.filter(item => item.category === selectedShoppingCategory.value);
            });

            const totalExpenseTWD = computed(() => {
                return expenses.value.reduce((total, item) => total + (item.amountTWD || 0), 0);
            });


            // --- æ ¸å¿ƒæ›´æ–°åœ°é»è³‡æ–™æ–¹æ³• (Google Maps å›å‚³) (KEEP) ---
            const updatePlaceDetails = (name, address, hoursDisplay) => {
                if (currentItem.value) {
                    currentItem.value.name = name;
                    currentItem.value.location = address;
                    currentItem.value.hoursDisplay = hoursDisplay; 
                    isPlaceSelected.value = true;
                }
            };
            window.appFunctions.updatePlaceDetails = updatePlaceDetails;


            // --- CRUD æ¨¡æ…‹è¦–çª—é‚è¼¯ (ä¿®æ”¹ä¿å­˜é‚è¼¯ç‚º triggerSave) ---
            
            const openAddModal = (date) => {
                isEditModalMode.value = false;
                modalType.value = 'itinerary';
                modalTitle.value = 'æ–°å¢æ™¯é»/ç¾é£Ÿ/æ´»å‹•';
                currentItem.value = { 
                    id: Date.now(),
                    category: 'æ™¯é»', 
                    name: '', 
                    startTime: '',
                    duration: '2h0m', 
                    endTime: '',
                    hoursDisplay: '', 
                    notes: '', 
                    location: '',
                    transport: 'å¤§çœ¾é‹è¼¸',
                    transportDuration: '30m', 
                    ticket: ''
                };
                currentItemDate.value = date;
                isPlaceSelected.value = false;
                showDeleteConfirm.value = false;
                isModalOpen.value = true;
                nextTick(() => {
                    if (window.initAutocomplete) window.initAutocomplete();
                });
            };

            const openEditModal = (item, date) => {
                if (item.category === 'èˆªç­' || item.category === 'ä½å®¿') {
                     if (!item.duration) item.duration = '1h'; 
                }
                isEditModalMode.value = true;
                modalType.value = 'itinerary';
                modalTitle.value = `ç·¨è¼¯: ${item.name}`;
                currentItem.value = JSON.parse(JSON.stringify(item));
                currentItemDate.value = date;
                isPlaceSelected.value = false;
                showDeleteConfirm.value = false;
                isModalOpen.value = true;
                nextTick(() => {
                    if (window.initAutocomplete) window.initAutocomplete();
                });
            };

            const openAddItemModal = (type, item = null) => {
                modalType.value = type;
                isEditModalMode.value = !!item; 
                showDeleteConfirm.value = false;

                if (type === 'shopping') {
                    modalTitle.value = isEditModalMode.value ? `ç·¨è¼¯è³¼ç‰©: ${item.name}` : 'æ–°å¢è³¼ç‰©é …ç›®';
                    currentItem.value = item ? JSON.parse(JSON.stringify(item)) : { id: Date.now(), name: '', category: 'ä¼´æ‰‹ç¦®', notes: '' };
                } else if (type === 'expense') {
                    modalTitle.value = isEditModalMode.value ? `ç·¨è¼¯èŠ±è²»: ${item.name}` : 'æ–°å¢èŠ±è²»è¨˜éŒ„';
                    currentItem.value = item ? JSON.parse(JSON.stringify(item)) : { id: Date.now(), name: '', category: 'é£²é£Ÿ', date: new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' }).replace(/\//g, '/'), amount: 0, currency: 'HKD', paymentMethod: 'ç¾é‡‘', payer: '', amountTWD: 0 };
                }
                isModalOpen.value = true;
            };

            const saveItem = () => {
                if (modalType.value === 'itinerary') {
                    const dayIndex = itineraryData.value.findIndex(d => d.date === currentItemDate.value);
                    if (dayIndex === -1) return;

                    const day = itineraryData.value[dayIndex];
                    
                    if (!currentItem.value.name || !currentItem.value.duration || !currentItem.value.transportDuration) {
                        alert('è«‹å¡«å¯«æ‰€æœ‰æ¨™é¡Œã€åœç•™æ™‚é–“èˆ‡äº¤é€šæ™‚é–“æ¬„ä½ï¼');
                        return;
                    }
                    
                    if (isEditModalMode.value) {
                        const index = day.items.findIndex(i => i.id === currentItem.value.id);
                        if (index !== -1) {
                            day.items[index] = currentItem.value;
                        }
                    } else {
                        day.items.push(currentItem.value);
                    }
                    
                    day.items.sort((a, b) => a.id - b.id); 
                    computeDayTimes(day);
                    
                } else if (modalType.value === 'shopping') {
                    if (!currentItem.value.name) return alert('è«‹å¡«å¯«å•†å“åç¨±ï¼');
                    if (isEditModalMode.value) {
                        const index = shoppingList.value.findIndex(i => i.id === currentItem.value.id);
                        if (index !== -1) shoppingList.value[index] = currentItem.value;
                    } else {
                        shoppingList.value.push(currentItem.value);
                    }
                    
                } else if (modalType.value === 'expense') {
                    if (!currentItem.value.name || !currentItem.value.amount || !currentItem.value.payer) return alert('è«‹å¡«å¯«åç¨±ã€é‡‘é¡èˆ‡ä»˜æ¬¾äººï¼');
                    
                    currentItem.value.amountTWD = currentItem.value.currency === 'HKD' 
                        ? currentItem.value.amount * exchangeRate 
                        : currentItem.value.amount;

                    if (isEditModalMode.value) {
                        const index = expenses.value.findIndex(i => i.id === currentItem.value.id);
                        if (index !== -1) expenses.value[index] = currentItem.value;
                    } else {
                        expenses.value.push(currentItem.value);
                    }
                }
                
                triggerSave(); // **å„²å­˜åˆ° Firebase**
                closeModal();
            };
            
            const deleteItem = () => {
                if (!currentItem.value) return;

                if (modalType.value === 'itinerary') {
                    const day = itineraryData.value.find(d => d.date === currentItemDate.value);
                    if (day) {
                        day.items = day.items.filter(i => i.id !== currentItem.value.id);
                        computeDayTimes(day); 
                    }
                } else if (modalType.value === 'shopping') {
                    shoppingList.value = shoppingList.value.filter(i => i.id !== currentItem.value.id);
                } else if (modalType.value === 'expense') {
                    expenses.value = expenses.value.filter(i => i.id !== currentItem.value.id);
                }
                
                triggerSave(); // **å„²å­˜åˆ° Firebase**
                closeModal();
            };


            // --- æ‹–æ›³/æ’åºé‚è¼¯ (ä¿®æ”¹ä¿å­˜é‚è¼¯ç‚º triggerSave) ---

            const handleDragStart = (event, index, date) => {
                const day = itineraryData.value.find(d => d.date === date);
                if (!day) return;
                const item = day.items[index];
                
                if (item.category === 'èˆªç­' || item.category === 'ä½å®¿') {
                     event.preventDefault(); 
                     return;
                }
                
                dragStartIndex.value = index;
                draggingDate.value = date;
                
                event.dataTransfer.setData('text/plain', JSON.stringify({ index, date }));
                event.currentTarget.classList.add('opacity-40');
            };

            const handleDragEnd = (event) => {
                event.currentTarget.classList.remove('opacity-40');
                dragStartIndex.value = -1;
                draggingDate.value = '';
            };

            const handleDrop = (event, targetIndex, date) => {
                event.preventDefault(); 
                event.currentTarget.classList.remove('border-b-4', 'border-dashed', 'border-deep-red');

                if (draggingDate.value !== date) return;
                if (dragStartIndex.value === -1) return;

                const day = itineraryData.value.find(d => d.date === date);
                if (!day) return;

                const targetItem = day.items[targetIndex];
                if (targetItem && (targetItem.category === 'èˆªç­' || targetItem.category === 'ä½å®¿')) return; 

                const draggedItem = day.items.splice(dragStartIndex.value, 1)[0];
                day.items.splice(targetIndex, 0, draggedItem);
                
                computeDayTimes(day); 
                triggerSave(); // **å„²å­˜åˆ° Firebase**

                dragStartIndex.value = -1;
            };

            const handleDragOver = (event, targetIndex, date) => {
                event.preventDefault(); 
                if (draggingDate.value !== date) return;

                const day = itineraryData.value.find(d => d.date === date);
                if (!day) return;
                const targetItem = day.items[targetIndex];
                if (targetItem && (targetItem.category === 'èˆªç­' || targetItem.category === 'ä½å®¿')) {
                     event.currentTarget.classList.remove('border-b-4', 'border-dashed', 'border-deep-red');
                     return; 
                }

                event.currentTarget.classList.add('border-b-4', 'border-dashed', 'border-deep-red');
            };

            const handleDragLeave = (event) => {
                 event.currentTarget.classList.remove('border-b-4', 'border-dashed', 'border-deep-red');
            };

            // --- æ¨£å¼/å·¥å…·å‡½å¼ (KEEP) ---
            
            const getCategoryClasses = (category) => {
                if (category === 'æ™¯é»') return 'bg-yellow-100 text-yellow-800';
                if (category === 'ç¾é£Ÿ') return 'bg-red-100 text-deep-red';
                if (category === 'è³¼ç‰©') return 'bg-green-100 text-green-800';
                if (category === 'ä½å®¿') return 'bg-blue-100 text-royal-blue';
                if (category === 'èˆªç­') return 'bg-gray-100 text-gray-600';
                if (category === 'äº¤é€š') return 'bg-purple-100 text-purple-700';
                return 'bg-gray-200 text-gray-700';
            };

            const getTransportIcon = (transport) => {
                if (transport === 'æ­¥è¡Œ') return 'fas fa-walking';
                if (transport === 'å¤§çœ¾é‹è¼¸') return 'fas fa-subway';
                if (transport === 'é–‹è»Š') return 'fas fa-car';
                if (transport === 'èˆªç­') return 'fas fa-plane-departure';
                return 'fas fa-bus-alt';
            };

            const openGoogleMaps = (location) => {
                const query = location;
                const mapUrl = `http://googleusercontent.com/maps.google.com/9{encodeURIComponent(query)}`;
                window.open(mapUrl, '_blank');
            };
            
            const closeModal = () => { 
                isModalOpen.value = false; 
                currentItem.value = null; 
                showDeleteConfirm.value = false; 
            }; 
            
            // æš´éœ²æ‰€æœ‰éœ€è¦çš„è®Šé‡å’Œå‡½æ•¸
            return {
                isEditMode, isMenuOpen, activeTab, selectedShoppingCategory, menus, activeDate, categories, 
                itineraryData, flightInfo, accommodationInfo, shoppingList, expenses, 
                foreignAmount, exchangeRate, payers,
                isModalOpen, isEditModalMode, showDeleteConfirm, modalTitle, modalType, currentItem, isPlaceSelected, currentItemDate,
                filteredShoppingList, totalExpenseTWD,

                // ä¿®æ­£ toggleEditMode, setActiveTab ç¢ºä¿åŒæ­¥åˆ° Firebase/LocalStorage
                toggleEditMode: () => { isEditMode.value = !isEditMode.value; }, 
                setActiveTab: (tab) => { activeTab.value = tab; isMenuOpen.value = false; },
                
                getCategoryClasses, getTransportIcon, 
                getWeatherIcon: (weather) => { 
                    if (weather === 'Sunny') return 'fas fa-sun';
                    return 'fas fa-cloud';
                }, 
                openGoogleMaps, openAddModal, openEditModal, openAddItemModal,
                closeModal, deleteItem, saveItem, 
                
                handleDragStart, 
                handleDragEnd, 
                handleDrop, 
                handleDragOver, 
                handleDragLeave, 
            }
        }
    // ç¶å®šåˆ° #app
    }).mount('#app')
</script>
</body>
</html>
