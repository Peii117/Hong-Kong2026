<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三美女遊香港 - 行程 Web App (免費版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* 定義港式極簡風格顏色及圖片底色延伸 */
        :root {
            --color-blue: #4169E1;  /* 萊茵藍 (Royal Blue) */
            --color-red: #D93025;   /* 港風紅 (Deep Red) */
            --color-bg-ext: #F5F7F8; /* 圖片底色延伸 (極淺灰藍) */
        }
        
        .bg-royal-blue { background-color: var(--color-blue); }
        .text-royal-blue { color: var(--color-blue); }
        .bg-deep-red { background-color: var(--color-red); }
        .text-deep-red { color: var(--color-red); }
        .bg-extension { background-color: var(--color-bg-ext); }

        /* 隱藏滾動條 */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* 日期選單樣式 */
        .date-item .day-of-week { font-size: 1.1rem; }
        .date-item .date-num { font-size: 2rem; line-height: 1; font-weight: 700; }
        
        /* 模態視窗過渡效果 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* 機票卡片虛線效果 */
        .ticket-card {
            background-color: white; 
            background-size: 100% 100%;
            position: relative;
        }

        .ticket-card::after {
            content: '';
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            height: 1px;
            background-image: linear-gradient(to right, #ccc 50%, transparent 50%);
            background-size: 15px 1px;
            background-repeat: repeat-x;
        }

        .ticket-cutout-left {
            position: absolute;
            bottom: 30px;
            left: -10px;
            width: 20px;
            height: 20px;
            background-color: #F3F4F6; /* 與父層背景同色 */
            border-radius: 50%;
            z-index: 10;
            border-right: 1px solid #ccc;
        }
        .ticket-cutout-right {
            position: absolute;
            bottom: 30px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-color: #F3F4F6;
            border-radius: 50%;
            z-index: 10;
            border-left: 1px solid #ccc;
        }
    </style>
</head>
<body class="bg-extension min-h-screen font-sans text-gray-700">

<div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen flex flex-col">
    
    <header class="relative flex-shrink-0">
        <div class="h-[200px] overflow-hidden relative bg-extension">
            <img src="https://images.unsplash.com/photo-1506318137071-a8bcbf6755dd?q=80&w=1000&auto=format&fit=crop" 
                 alt="香港街景" 
                 class="w-full h-full object-cover mx-auto absolute">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
            <div class="absolute bottom-4 left-4 text-white">
                <h1 class="text-2xl font-bold">三美女遊香港</h1>
                <p class="text-sm opacity-90">吃喝玩樂全攻略</p>
            </div>
        </div>
        
        <div class="absolute top-0 left-0 right-0 z-20 flex justify-between items-center p-4">
            <button @click="toggleEditMode" 
                    :class="{'bg-deep-red text-white shadow-xl': isEditMode, 'bg-white/90 text-gray-700': !isEditMode}" 
                    class="px-3 py-2 rounded-full transition duration-300 shadow-md flex items-center text-sm font-semibold backdrop-blur-sm">
                <i :class="isEditMode ? 'fas fa-pen-nib' : 'fas fa-eye'" class="mr-2"></i>
                {{ isEditMode ? '編輯模式' : '瀏覽模式' }}
            </button>

            <button @click="isMenuOpen = !isMenuOpen" 
                    class="p-2 w-10 h-10 rounded-full bg-white/90 text-gray-700 shadow-md hover:bg-white transition duration-300 backdrop-blur-sm flex items-center justify-center">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>
    
    <Transition name="fade">
    <div v-if="isMenuOpen" class="fixed inset-0 z-50">
        <div @click="isMenuOpen = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="absolute top-0 right-0 w-64 bg-white h-full shadow-2xl p-6 transform transition-transform duration-300">
            <h3 class="text-xl font-bold mb-6 text-gray-800 border-b pb-4">功能選單</h3>
            <ul class="space-y-2">
                <li v-for="menu in menus" :key="menu.tab" 
                   @click="setActiveTab(menu.tab)"
                   :class="{'bg-deep-red text-white shadow-md': activeTab === menu.tab, 'text-gray-700 hover:bg-gray-100': activeTab !== menu.tab}"
                   class="p-3 rounded-lg flex items-center cursor-pointer transition duration-200">
                   <i :class="menu.icon" class="w-8 text-center mr-2"></i>
                   <span>{{ menu.name }}</span>
                </li>
            </ul>
            <div class="mt-8 pt-4 border-t text-xs text-gray-400 text-center">
                <p>資料自動儲存於此裝置</p>
            </div>
        </div>
    </div>
    </Transition>

    <main class="flex-grow relative z-0 bg-gray-50 -mt-4 rounded-t-3xl pt-6">
        
        <Transition name="fade" mode="out-in">
        <section v-if="activeTab === 'itinerary'" key="itinerary">
            
            <div class="px-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-2xl flex items-center shadow-sm border-l-4 border-royal-blue">
                    <i class="fas fa-sun text-orange-400 text-4xl mr-4 flex-shrink-0"></i>
                    <div class="flex-grow">
                        <div class="font-bold text-gray-800 flex justify-between items-center">
                            <span>香港天氣預報</span>
                            <span class="text-xs font-normal text-white bg-red-400 px-2 py-0.5 rounded-full">降雨 15%</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">氣溫: 22°C <span class="text-gray-400">|</span> 體感: 24°C</p>
                        <p class="text-xs text-blue-600 mt-1"><i class="fas fa-tshirt mr-1"></i>建議: 薄外套、舒適好走的鞋</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center px-4 mb-2">
                <h2 class="text-xl font-bold text-gray-800 border-l-4 border-deep-red pl-3">每日行程</h2>
                <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">Day {{ getDayIndex(activeDate) + 1 }}</span>
            </div>

            <div class="flex overflow-x-auto space-x-3 pb-4 px-4 hide-scrollbar mb-2">
                <div v-for="day in itineraryData" :key="day.date" 
                     @click="activeDate = day.date"
                     :class="{'bg-royal-blue text-white shadow-lg scale-105': activeDate === day.date, 'bg-white border border-gray-200 text-gray-400 hover:bg-gray-50': activeDate !== day.date}" 
                     class="flex-shrink-0 w-16 h-20 flex flex-col items-center justify-center rounded-2xl cursor-pointer transition-all duration-300">
                    <span class="text-xs font-medium mb-1">{{ day.dayOfWeek }}</span>
                    <span class="text-2xl font-bold leading-none">{{ day.date.split('/')[2] }}</span>
                </div>
            </div>
            
            <div class="px-4 pb-20">
                <div v-for="day in itineraryData" :key="day.date">
                    <div v-if="activeDate === day.date">
                        
                        <button v-if="isEditMode" @click="openAddModal(day.date)" 
                            class="w-full bg-green-50 text-green-600 border-2 border-dashed border-green-300 p-3 rounded-xl mb-6 hover:bg-green-100 transition duration-200 font-semibold flex items-center justify-center group">
                            <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2 group-hover:scale-110 transition">
                                <i class="fas fa-plus text-xs"></i>
                            </span>
                            新增行程
                        </button>
                        
                        <div class="space-y-6 relative">
                            <div class="absolute left-8 top-4 bottom-4 w-0.5 bg-gray-200 -z-10"></div>

                            <div v-for="(item, index) in day.items" :key="item.id" 
                                 :class="{'cursor-pointer hover:shadow-lg hover:-translate-y-1 transition duration-200': isEditMode, 'opacity-75': item.category === '交通'}"
                                 @click="isEditMode && openEditModal(item, day.date)"
                                 class="relative pl-16">
                                
                                <div class="absolute left-6 top-6 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10"
                                     :class="item.category === '交通' ? 'bg-gray-400' : 'bg-royal-blue'"></div>

                                <div v-if="index > 0 && item.transport" class="absolute -top-3 left-14 text-xs text-gray-400 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100 flex items-center">
                                    <i :class="getTransportIcon(item.transport)" class="mr-1.5"></i>
                                    <span>{{ item.transportDuration }}</span>
                                </div>
                                
                                <template v-if="item.category === '航班'">
                                    <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 ticket-card">
                                        <div class="flex justify-between items-center mb-3">
                                           <span class="text-xs font-bold px-2 py-0.5 rounded text-gray-500 bg-gray-100"><i class="fas fa-plane mr-1"></i>航班</span>
                                           <span class="text-lg font-mono font-bold text-deep-red">{{ item.flightNumber }}</span>
                                        </div>
                                        
                                        <div class="flex justify-between items-center text-gray-700 mb-2">
                                            <div class="text-center">
                                                <p class="font-bold text-xl">{{ item.startTime }}</p>
                                                <p class="text-xs text-gray-400">{{ item.fromAirport }}</p>
                                            </div>
                                            <div class="flex flex-col items-center px-4">
                                                <i class="fas fa-plane text-gray-300 transform rotate-90 mb-1"></i>
                                                <div class="h-[1px] w-12 bg-gray-300"></div>
                                                <p class="text-xs text-gray-400 mt-1">{{ item.duration }}</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="font-bold text-xl">{{ item.endTime }}</p>
                                                <p class="text-xs text-gray-400">{{ item.toAirport }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="ticket-cutout-left"></div>
                                        <div class="ticket-cutout-right"></div>

                                        <div class="flex justify-between items-center mt-6 text-xs text-gray-500 font-mono">
                                            <p>{{ item.airline }}</p>
                                            <p>{{ item.notes }}</p>
                                        </div>
                                    </div>
                                </template>
                                
                                <template v-else>
                                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 transition-all duration-200"
                                         :style="{'border-left-color': getCategoryColor(item.category)}">
                                        
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full text-white mb-1 inline-block"
                                                      :style="{backgroundColor: getCategoryColor(item.category)}">
                                                    {{ item.category }}
                                                </span>
                                                <h3 class="text-lg font-bold text-gray-800 leading-tight">{{ item.name }}</h3>
                                            </div>
                                            <button @click.stop="openGoogleMaps(item.location || item.name)" 
                                                    title="Google 導航" 
                                                    class="w-10 h-10 rounded-full bg-blue-50 text-royal-blue flex items-center justify-center hover:bg-royal-blue hover:text-white transition-colors shadow-sm flex-shrink-0 ml-2">
                                                <i class="fas fa-location-arrow"></i>
                                            </button>
                                        </div>
                                        
                                        <div class="space-y-1.5">
                                            <div class="flex items-center text-sm text-gray-700">
                                                <i class="far fa-clock w-5 text-gray-400 text-center mr-2"></i>
                                                <span class="font-semibold">{{ item.startTime }}</span>
                                                <span v-if="item.endTime" class="mx-1">-</span>
                                                <span v-if="item.endTime">{{ item.endTime }}</span>
                                                <span v-if="item.duration" class="text-xs text-gray-400 ml-2">({{ item.duration }})</span>
                                            </div>
                                            
                                            <div v-if="item.location" class="flex items-start text-sm text-gray-500">
                                                <i class="fas fa-map-marker-alt w-5 text-gray-400 text-center mr-2 mt-0.5"></i>
                                                <span class="line-clamp-1">{{ item.location }}</span>
                                            </div>

                                            <div v-if="item.notes" class="flex items-start text-sm text-gray-500 bg-gray-50 p-2 rounded-lg mt-2">
                                                <i class="fas fa-sticky-note w-5 text-gray-400 text-center mr-2 mt-0.5"></i>
                                                <span>{{ item.notes }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section v-else-if="activeTab === 'info'" key="info" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-deep-red pl-3">旅行小幫手</h2>
            
            <div class="bg-white p-5 rounded-2xl mb-6 shadow-md border-t-4 border-royal-blue">
                <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center">
                    <span class="w-8 h-8 rounded-full bg-blue-100 text-royal-blue flex items-center justify-center mr-2"><i class="fas fa-coins"></i></span>
                    匯率換算
                </h3>
                <p class="text-xs text-gray-400 mb-4">預設匯率: 1 HKD = {{ exchangeRate }} TWD</p>
                
                <div class="flex items-center justify-between space-x-2 bg-gray-50 p-4 rounded-xl">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 font-bold block mb-1">港幣 (HKD)</label>
                        <input type="number" v-model.number="foreignAmount" placeholder="0" class="w-full bg-transparent text-xl font-bold text-gray-800 outline-none border-b border-gray-300 focus:border-royal-blue transition">
                    </div>
                    <i class="fas fa-exchange-alt text-gray-300"></i>
                    <div class="flex-1 text-right">
                        <label class="text-xs text-gray-500 font-bold block mb-1">台幣 (TWD)</label>
                        <span class="text-xl font-bold text-deep-red">{{ (foreignAmount * exchangeRate).toFixed(0) }}</span>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <label class="text-xs text-gray-400 block mb-1">自訂匯率</label>
                    <input type="number" v-model.number="exchangeRate" class="w-20 bg-gray-100 rounded px-2 py-1 text-sm">
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl mb-6 shadow-md border-t-4 border-green-500">
                <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center">
                    <span class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-2"><i class="fas fa-hotel"></i></span>
                    住宿資訊
                </h3>
                <div v-for="hotel in accommodationInfo" :key="hotel.name" class="bg-gray-50 p-3 rounded-lg">
                    <p class="font-bold text-gray-800">{{ hotel.name }}</p>
                    <p class="text-sm text-gray-600 mt-1"><i class="far fa-calendar-alt mr-1"></i> {{ hotel.dates }}</p>
                    <p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt mr-1"></i> {{ hotel.address }}</p>
                    <button @click="openGoogleMaps(hotel.address)" class="mt-3 w-full py-2 bg-white border border-gray-200 rounded-lg text-sm font-semibold text-royal-blue hover:bg-blue-50 transition">
                        <i class="fas fa-location-arrow mr-1"></i> 導航至飯店
                    </button>
                </div>
            </div>
        </section>
        
        <section v-else-if="activeTab === 'shopping'" key="shopping" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-3">購物願望清單</h2>
            
            <button v-if="isEditMode" @click="openAddItemModal('shopping')" 
                class="w-full bg-royal-blue text-white p-3 rounded-xl mb-6 shadow-lg shadow-blue-200 hover:bg-blue-600 transition duration-200 font-semibold flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> 新增必買項目
            </button>

            <div class="flex space-x-2 mb-4 overflow-x-auto hide-scrollbar">
                <button v-for="cat in ['all', '伴手禮', '美妝', '藥妝', '紀念品']" 
                        :key="cat"
                        @click="selectedShoppingCategory = cat" 
                        :class="{'bg-deep-red text-white': selectedShoppingCategory === cat, 'bg-white text-gray-500 border border-gray-200': selectedShoppingCategory !== cat}" 
                        class="px-4 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors">
                    {{ cat === 'all' ? '全部' : cat }}
                </button>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <div v-for="item in filteredShoppingList" :key="item.id" 
                     @click="isEditMode && openAddItemModal('shopping', item)"
                     class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center">
                    
                    <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 mr-3 flex-shrink-0">
                        <i class="fas fa-shopping-bag text-xl"></i>
                    </div>
                    
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                            <span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">{{ item.category }}</span>
                        </div>
                        <p v-if="item.notes" class="text-sm text-gray-500 mt-0.5 line-clamp-1">{{ item.notes }}</p>
                    </div>
                    
                    <button v-if="isEditMode" @click.stop="deleteItem('shopping', item.id)" class="ml-2 text-gray-300 hover:text-red-500 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div v-if="filteredShoppingList.length === 0" class="text-center py-10 text-gray-400">
                <i class="fas fa-shopping-basket text-4xl mb-2 opacity-30"></i>
                <p>目前沒有項目</p>
            </div>
        </section>
        
        <section v-else-if="activeTab === 'expense'" key="expense" class="p-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-3">旅費統計</h2>
            
            <div class="bg-gradient-to-r from-gray-800 to-gray-700 text-white p-6 rounded-2xl mb-6 shadow-xl relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                <p class="text-gray-300 text-sm mb-1">總支出估算 (TWD)</p>
                <p class="text-4xl font-bold tracking-tight">$ {{ totalExpenseTWD.toLocaleString() }}</p>
                <div class="mt-4 flex space-x-4 text-sm text-gray-300">
                    <div><span class="block text-xs opacity-70">現金</span> {{ calculateTotal('現金') }}</div>
                    <div><span class="block text-xs opacity-70">信用卡</span> {{ calculateTotal('信用卡') }}</div>
                </div>
            </div>

            <button v-if="isEditMode" @click="openAddItemModal('expense')" 
                class="w-full bg-white text-gray-700 border border-gray-200 p-3 rounded-xl mb-4 hover:bg-gray-50 transition duration-200 font-semibold shadow-sm">
                <i class="fas fa-plus text-deep-red mr-1"></i> 記一筆
            </button>

            <div class="space-y-3 pb-20">
                <div v-for="item in expenses" :key="item.id" 
                     @click="isEditMode && openAddItemModal('expense', item)"
                     class="bg-white p-3 rounded-xl shadow-sm border-l-4 flex justify-between items-center"
                     :style="{'border-left-color': item.paymentMethod === '現金' ? '#10B981' : '#3B82F6'}">
                    
                    <div>
                        <div class="flex items-center space-x-2">
                            <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                            <span v-if="item.payer" class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ item.payer }}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">{{ item.date }} · {{ item.category }}</p>
                    </div>
                    
                    <div class="text-right">
                        <p class="font-bold text-gray-800">{{ item.amount }} <span class="text-xs">{{ item.currency }}</span></p>
                        <p class="text-xs text-gray-400">≈ {{ Math.round(item.amount * (item.currency === 'HKD' ? exchangeRate : 1)).toLocaleString() }} TWD</p>
                    </div>
                </div>
            </div>
        </section>
        </Transition>
        
    </main>

    <Transition name="fade">
    <div v-if="isModalOpen && currentItem" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div @click="closeModal" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl relative z-10 max-h-[90vh] flex flex-col">
            
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-800">{{ modalTitle }}</h3>
                <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <div class="p-5 overflow-y-auto hide-scrollbar flex-grow">
                <form @submit.prevent="saveItem" id="editForm" class="space-y-4">
                    
                    <template v-if="modalType === 'itinerary'">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wide">基本資訊</div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">名稱</label>
                            <input type="text" v-model="currentItem.name" required placeholder="例如：維多利亞港"
                                   class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none transition">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">分類</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" v-for="cat in categories.filter(c => c !== '航班')" :key="cat"
                                        @click="currentItem.category = cat"
                                        :class="currentItem.category === cat ? 'bg-royal-blue text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                                        class="px-3 py-1.5 rounded-lg text-sm transition-all">
                                    {{ cat }}
                                </button>
                            </div>
                        </div>

                        <div v-if="currentItem.category !== '交通'">
                            <label class="block text-sm font-semibold mb-1 text-gray-700">地點 (用於導航)</label>
                            <div class="relative">
                                <i class="fas fa-map-pin absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="text" v-model="currentItem.location" placeholder="輸入關鍵字，點擊導航時搜尋" 
                                       class="w-full p-3 pl-10 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none transition">
                            </div>
                            <p class="text-xs text-gray-400 mt-1 ml-1">* 不需精確地址，輸入地標名稱即可</p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl space-y-3">
                            <div class="text-xs font-bold text-blue-500 uppercase tracking-wide">時間設定</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">開始時間</label>
                                    <input type="time" v-model="currentItem.startTime" class="w-full p-2 bg-white rounded-lg border-none shadow-sm focus:ring-2 focus:ring-blue-300">
                                </div>
                                <div v-if="currentItem.category !== '交通'">
                                    <label class="block text-xs text-gray-500 mb-1">預計停留</label>
                                    <input type="text" v-model="currentItem.duration" placeholder="例如: 1h 30m" class="w-full p-2 bg-white rounded-lg border-none shadow-sm focus:ring-2 focus:ring-blue-300">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">筆記 / 備註</label>
                            <textarea v-model="currentItem.notes" rows="3" placeholder="例如：必吃蛋塔、記得預約..."
                                      class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none transition"></textarea>
                        </div>
                        
                        <div v-if="isEditModalMode" class="pt-2">
                             <button type="button" @click="deleteItem('itinerary', currentItem.id)" class="text-red-500 text-sm flex items-center hover:underline">
                                <i class="fas fa-trash-alt mr-1"></i> 刪除此行程
                             </button>
                        </div>
                    </template>

                    <template v-else-if="modalType === 'shopping'">
                        <div>
                            <label class="block text-sm font-semibold mb-1">商品名稱</label>
                            <input type="text" v-model="currentItem.name" required class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">分類</label>
                            <select v-model="currentItem.category" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none">
                                <option value="伴手禮">伴手禮</option>
                                <option value="美妝">美妝</option>
                                <option value="藥妝">藥妝</option>
                                <option value="紀念品">紀念品</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">備註 (哪裡買/價格)</label>
                            <input type="text" v-model="currentItem.notes" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-royal-blue outline-none">
                        </div>
                    </template>

                    <template v-else-if="modalType === 'expense'">
                        <div>
                            <label class="block text-sm font-semibold mb-1">項目名稱</label>
                            <input type="text" v-model="currentItem.name" required class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-deep-red outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="block text-sm font-semibold mb-1">金額</label>
                                <input type="number" v-model.number="currentItem.amount" required class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-deep-red outline-none">
                             </div>
                             <div>
                                <label class="block text-sm font-semibold mb-1">幣別</label>
                                <select v-model="currentItem.currency" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-deep-red outline-none">
                                    <option value="HKD">HKD</option>
                                    <option value="TWD">TWD</option>
                                </select>
                             </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                               <label class="block text-sm font-semibold mb-1">付款人</label>
                               <select v-model="currentItem.payer" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-deep-red outline-none">
                                   <option value="沛晴">沛晴</option>
                                   <option value="芳晨">芳晨</option>
                                   <option value="玟妤">玟妤</option>
                               </select>
                            </div>
                            <div>
                               <label class="block text-sm font-semibold mb-1">方式</label>
                               <select v-model="currentItem.paymentMethod" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-deep-red outline-none">
                                   <option value="現金">現金</option>
                                   <option value="信用卡">信用卡</option>
                               </select>
                            </div>
                         </div>
                    </template>

                </form>
            </div>
            
            <div class="p-4 border-t flex-shrink-0">
                <button type="button" @click="saveItem" 
                        class="w-full bg-gray-800 text-white p-3 rounded-xl font-bold shadow-lg hover:bg-black transition duration-200">
                    {{ isEditModalMode ? '儲存變更' : '新增項目' }}
                </button>
            </div>
        </div>
    </div>
    </Transition>

</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        // --- 狀態定義 ---
        const activeTab = ref('itinerary');
        const isEditMode = ref(false);
        const isMenuOpen = ref(false);
        const activeDate = ref('2026/03/07');
        const exchangeRate = ref(4.1); // 預設匯率
        const foreignAmount = ref(100);
        
        // Modal 相關
        const isModalOpen = ref(false);
        const modalType = ref('itinerary'); // 'itinerary', 'shopping', 'expense'
        const currentItem = ref(null);
        const isEditModalMode = ref(false);
        const currentItemDate = ref('');

        const selectedShoppingCategory = ref('all');
        const categories = ['景點', '美食', '購物', '交通', '住宿', '航班'];

        const menus = [
            { name: '行程表', tab: 'itinerary', icon: 'fas fa-map-marked-alt' },
            { name: '資訊 (住宿/航班)', tab: 'info', icon: 'fas fa-info-circle' },
            { name: '購物清單', tab: 'shopping', icon: 'fas fa-shopping-bag' },
            { name: '記帳小本本', tab: 'expense', icon: 'fas fa-file-invoice-dollar' }
        ];

        // --- 預設資料 (如果是第一次開啟) ---
        const defaultItinerary = [
            {
                date: '2026/03/07',
                dayOfWeek: '週六',
                items: [
                    { id: 1, category: '航班', name: '去程班機', flightNumber: 'CI909', fromAirport: 'TPE', toAirport: 'HKG', startTime: '11:00', endTime: '12:55', duration: '1h55m', airline: '中華航空', notes: '記得提早2小時到機場', location: '桃園機場' },
                    { id: 2, category: '交通', name: '機場快線', transport: '大眾運輸', transportDuration: '24m', startTime: '13:30', location: '香港國際機場' },
                    { id: 3, category: '住宿', name: 'Check-in 放行李', startTime: '14:30', duration: '30m', location: '香港喜來登酒店', notes: '尖沙咀站 E 出口' },
                    { id: 4, category: '美食', name: '澳洲牛奶公司', startTime: '15:30', duration: '1h', location: '澳洲牛奶公司', notes: '必點炒蛋多士、燉奶' },
                    { id: 5, category: '景點', name: '維多利亞港夜景', startTime: '19:30', duration: '1h', location: '尖沙咀海濱花園', notes: '幻彩詠香江 20:00 開始' }
                ]
            },
            {
                date: '2026/03/08',
                dayOfWeek: '週日',
                items: [
                    { id: 101, category: '景點', name: '香港迪士尼樂園', startTime: '10:00', duration: '8h', location: '香港迪士尼樂園', notes: '記得先下載 App 預約' }
                ]
            },
            {
                date: '2026/03/09',
                dayOfWeek: '週一',
                items: [
                    { id: 201, category: '美食', name: '蘭芳園', startTime: '09:00', duration: '1h', location: '中環蘭芳園', notes: '絲襪奶茶始祖' },
                    { id: 202, category: '購物', name: '中環逛街', startTime: '10:30', duration: '3h', location: 'IFC Mall', notes: '買伴手禮' }
                ]
            }
        ];

        // --- 響應式資料 ---
        const itineraryData = ref(defaultItinerary);
        const shoppingList = ref([
            { id: 1, name: '珍妮曲奇', category: '伴手禮', notes: '4 mix 小盒' },
            { id: 2, name: '黃道益活絡油', category: '藥妝', notes: '萬寧買比較便宜' }
        ]);
        const expenses = ref([
            { id: 1, name: '機票', amount: 8500, currency: 'TWD', category: '交通', date: '2025/12/01', paymentMethod: '信用卡', payer: '沛晴' }
        ]);
        
        const accommodationInfo = ref([
            { name: '香港喜來登酒店', dates: '3/7 - 3/9 (2晚)', address: '香港九龍尖沙咀彌敦道20號' }
        ]);

        // --- LocalStorage 讀取與儲存 ---
        const loadData = () => {
            const savedItinerary = localStorage.getItem('hk_itinerary');
            const savedShopping = localStorage.getItem('hk_shopping');
            const savedExpense = localStorage.getItem('hk_expense');
            const savedRate = localStorage.getItem('hk_rate');
            
            if (savedItinerary) itineraryData.value = JSON.parse(savedItinerary);
            if (savedShopping) shoppingList.value = JSON.parse(savedShopping);
            if (savedExpense) expenses.value = JSON.parse(savedExpense);
            if (savedRate) exchangeRate.value = parseFloat(savedRate);
        };

        const saveData = () => {
            localStorage.setItem('hk_itinerary', JSON.stringify(itineraryData.value));
            localStorage.setItem('hk_shopping', JSON.stringify(shoppingList.value));
            localStorage.setItem('hk_expense', JSON.stringify(expenses.value));
            localStorage.setItem('hk_rate', exchangeRate.value.toString());
        };

        // 監聽資料變更自動儲存
        watch([itineraryData, shoppingList, expenses, exchangeRate], () => {
            saveData();
        }, { deep: true });

        // --- Computed ---
        const filteredShoppingList = computed(() => {
            if (selectedShoppingCategory.value === 'all') return shoppingList.value;
            return shoppingList.value.filter(item => item.category === selectedShoppingCategory.value);
        });

        const totalExpenseTWD = computed(() => {
            return expenses.value.reduce((total, item) => {
                const rate = item.currency === 'HKD' ? exchangeRate.value : 1;
                return total + (item.amount * rate);
            }, 0);
        });

        const modalTitle = computed(() => {
            if (modalType.value === 'itinerary') return isEditModalMode.value ? '編輯行程' : '新增行程';
            if (modalType.value === 'shopping') return isEditModalMode.value ? '編輯商品' : '新增商品';
            return isEditModalMode.value ? '編輯款項' : '新增款項';
        });

        // --- Methods ---
        const toggleEditMode = () => {
            isEditMode.value = !isEditMode.value;
        };

        const setActiveTab = (tab) => {
            activeTab.value = tab;
            isMenuOpen.value = false;
        };

        const getDayIndex = (dateStr) => {
            return itineraryData.value.findIndex(d => d.date === dateStr);
        };

        // 關鍵功能：免費開啟 Google Maps 連結
        const openGoogleMaps = (locationName) => {
            if (!locationName) return;
            // 加上 "香港" 關鍵字以提高搜尋準確度
            const query = encodeURIComponent(locationName + " 香港");
            // 使用通用搜尋協議，會自動喚起 App 或開啟網頁
            const url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            window.open(url, '_blank');
        };

        // Modal 操作
        const openAddModal = (dateOrType, defaultItem = null) => {
            isEditModalMode.value = false;
            
            if (typeof dateOrType === 'string' && dateOrType.includes('/')) {
                // 新增行程
                modalType.value = 'itinerary';
                currentItemDate.value = dateOrType;
                currentItem.value = { 
                    id: Date.now(), 
                    category: '景點', 
                    name: '', 
                    location: '', 
                    startTime: '', 
                    duration: '', 
                    notes: '' 
                };
            } else {
                // 新增購物或記帳
                modalType.value = dateOrType; // 'shopping' or 'expense'
                if (modalType.value === 'shopping') {
                    currentItem.value = { id: Date.now(), name: '', category: '伴手禮', notes: '' };
                } else {
                    currentItem.value = { id: Date.now(), name: '', amount: '', currency: 'HKD', category: '飲食', date: new Date().toLocaleDateString(), paymentMethod: '現金', payer: '沛晴' };
                }
            }
            isModalOpen.value = true;
        };

        const openEditModal = (item, date = null) => {
            isEditModalMode.value = true;
            currentItem.value = JSON.parse(JSON.stringify(item)); // Deep copy
            if (date) {
                modalType.value = 'itinerary';
                currentItemDate.value = date;
            } else if (item.paymentMethod) {
                modalType.value = 'expense';
            } else {
                modalType.value = 'shopping';
            }
            isModalOpen.value = true;
        };

        const closeModal = () => {
            isModalOpen.value = false;
            currentItem.value = null;
        };

        const saveItem = () => {
            if (modalType.value === 'itinerary') {
                const dayIndex = itineraryData.value.findIndex(d => d.date === currentItemDate.value);
                if (dayIndex === -1) return;
                
                const items = itineraryData.value[dayIndex].items;
                if (isEditModalMode.value) {
                    const itemIndex = items.findIndex(i => i.id === currentItem.value.id);
                    if (itemIndex !== -1) items[itemIndex] = currentItem.value;
                } else {
                    items.push(currentItem.value);
                    // 簡單排序：依據 startTime (如果有的話)
                    items.sort((a, b) => (a.startTime || '99:99').localeCompare(b.startTime || '99:99'));
                }
            } else if (modalType.value === 'shopping') {
                if (isEditModalMode.value) {
                    const idx = shoppingList.value.findIndex(i => i.id === currentItem.value.id);
                    if (idx !== -1) shoppingList.value[idx] = currentItem.value;
                } else {
                    shoppingList.value.push(currentItem.value);
                }
            } else if (modalType.value === 'expense') {
                if (isEditModalMode.value) {
                    const idx = expenses.value.findIndex(i => i.id === currentItem.value.id);
                    if (idx !== -1) expenses.value[idx] = currentItem.value;
                } else {
                    expenses.value.push(currentItem.value);
                }
            }
            closeModal();
            saveData();
        };

        const deleteItem = (type, id) => {
            if (!confirm('確定要刪除嗎？')) return;
            
            if (type === 'itinerary') {
                const dayIndex = itineraryData.value.findIndex(d => d.date === currentItemDate.value);
                if (dayIndex !== -1) {
                    itineraryData.value[dayIndex].items = itineraryData.value[dayIndex].items.filter(i => i.id !== id);
                }
                closeModal(); // 如果是在編輯視窗中刪除，關閉視窗
            } else if (type === 'shopping') {
                shoppingList.value = shoppingList.value.filter(i => i.id !== id);
            }
            saveData();
        };

        // --- Helper Functions ---
        const getTransportIcon = (type) => {
            const map = { '步行': 'fas fa-walking', '大眾運輸': 'fas fa-subway', '開車': 'fas fa-taxi' };
            return map[type] || 'fas fa-arrow-right';
        };

        const getCategoryColor = (cat) => {
            const map = { 
                '美食': '#F59E0B', // Amber
                '景點': '#D93025', // Red
                '購物': '#10B981', // Emerald
                '交通': '#6B7280', // Gray
                '住宿': '#4169E1'  // Blue
            };
            return map[cat] || '#8B5CF6';
        };

        const calculateTotal = (method) => {
            const total = expenses.value
                .filter(e => e.paymentMethod === method)
                .reduce((sum, item) => {
                    const rate = item.currency === 'HKD' ? exchangeRate.value : 1;
                    return sum + (item.amount * rate);
                }, 0);
            return Math.round(total).toLocaleString();
        };

        onMounted(() => {
            loadData();
        });

        return {
            activeTab, isEditMode, isMenuOpen, activeDate,
            itineraryData, shoppingList, expenses,
            flightInfo: [], // 可根據需要補上
            accommodationInfo,
            isModalOpen, modalType, currentItem, isEditModalMode, currentItemDate,
            categories, selectedShoppingCategory,
            filteredShoppingList, totalExpenseTWD, modalTitle,
            toggleEditMode, setActiveTab, getDayIndex, openGoogleMaps,
            openAddModal, openEditModal, closeModal, saveItem, deleteItem,
            getTransportIcon, getCategoryColor,
            exchangeRate, foreignAmount, calculateTotal, menus
        };
    }
}).mount('#app');
</script>
</body>
</html>
